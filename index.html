<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepairFlow ERP - Electronics Repair & Resell</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; }
        }
        .print-only { display: none; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Toast animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        
        /* Timeline styles */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 30px;
            bottom: -10px;
            width: 2px;
            background: #334155;
        }
        .timeline-item:last-child::before { display: none; }
        
        /* Badge pulse */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .badge-pulse { animation: pulse 2s infinite; }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Status colors */
        .status-fresh { background: #22c55e; }
        .status-slow { background: #eab308; }
        .status-dead { background: #ef4444; }
        
        /* Risk colors */
        .risk-low { color: #22c55e; }
        .risk-medium { color: #eab308; }
        .risk-high { color: #ef4444; }
        
        /* Transition utilities */
        .transition-all { transition: all 0.2s ease; }
        
        /* Card hover effect */
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>
    
    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 z-40"></div>
    
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">RepairFlow ERP</h1>
                <p class="text-slate-500 mt-1">Electronics Repair & Resell System</p>
            </div>
            <form id="login-form" onsubmit="Auth.handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                    <input type="text" id="login-username" required placeholder="Enter username" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password" required placeholder="Enter password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="hidden text-red-500 text-sm text-center"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                    Login
                </button>
            </form>
            <div class="mt-6 pt-6 border-t border-slate-200 text-center space-y-3">
                <button onclick="Auth.goToPublicTracking()" class="block w-full text-blue-600 hover:text-blue-800 font-medium text-sm">
                    Track Repair Status (No login required) →
                </button>
                <button onclick="Auth.goToPublicTradeIn()" class="block w-full text-green-600 hover:text-green-800 font-medium text-sm">
                    Trade-In Your Device (No login required) →
                </button>
            </div>
            <p class="text-xs text-slate-400 mt-4 text-center">Default: admin / admin</p>
        </div>
    </div>
    
    <!-- Main Layout -->
    <div id="main-app" class="flex min-h-screen hidden">
        <!-- Sidebar -->
        <aside class="sidebar fixed left-0 top-0 h-full w-64 bg-slate-900 text-white flex flex-col no-print z-30">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                    </svg>
                    RepairFlow ERP
                </h1>
                <p class="text-slate-400 text-sm mt-1">Electronics Repair & Resell</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="App.navigate('dashboard')" data-nav="dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                    Dashboard
                </button>
                
                <button onclick="App.navigate('inventory')" data-nav="inventory" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Inventory
                    <span id="inventory-count" class="ml-auto bg-slate-700 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                
                <button onclick="App.navigate('trade')" data-nav="trade" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    Trade Engine
                </button>
                
                <button onclick="App.navigate('service')" data-nav="service" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Service Center
                    <span id="service-count" class="ml-auto bg-blue-600 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                
                <button onclick="App.navigate('tracking')" data-nav="tracking" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Public Tracking
                </button>
                
                <button onclick="App.navigate('finance')" data-nav="finance" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Finance
                </button>
                
                <button onclick="App.navigate('forecast')" data-nav="forecast" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Forecasting
                </button>
                
                <button onclick="App.navigate('audit')" data-nav="audit" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    Audit Log
                </button>
                
                <button onclick="App.navigate('parts-inventory')" data-nav="parts-inventory" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    Parts Inventory
                    <span id="parts-inventory-count" class="ml-auto bg-purple-600 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                
                <button onclick="App.navigate('tradein-requests')" data-nav="tradein-requests" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Trade-In Requests
                    <span id="tradein-requests-count" class="ml-auto bg-green-600 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                
                <!-- Users Management - Admin Only -->
                <button onclick="App.navigate('users')" data-nav="users" id="nav-users" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    Users
                    <span id="users-count" class="ml-auto bg-red-600 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                
                <!-- Settings -->
                <button onclick="App.navigate('settings')" data-nav="settings" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Settings
                </button>
            </nav>
            
            <div class="p-4 border-t border-slate-700 space-y-3">
                <!-- User Info & Logout -->
                <div class="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold" id="sidebar-user-avatar">A</div>
                        <div>
                            <p class="text-sm font-medium text-white" id="sidebar-user-name">Admin</p>
                            <p class="text-xs text-slate-400" id="sidebar-user-role">admin</p>
                        </div>
                    </div>
                    <button onclick="Auth.logout()" title="Logout" class="text-slate-400 hover:text-red-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                <div class="text-xs text-slate-500">
                    <p>Version 1.0.0</p>
                    <p class="mt-1">Data stored locally</p>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content flex-1 ml-64 p-8">
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Dashboard</h2>
                    <p class="text-slate-500 mt-1">Overview of your repair and resell business</p>
                </div>
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="text-green-500 text-sm font-medium" id="kpi-revenue-change">+0%</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Total Revenue</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-revenue">€0.00</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <span class="text-blue-500 text-sm font-medium" id="kpi-profit-margin">0%</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Total Profit</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-profit">€0.00</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                            </div>
                            <span class="text-purple-500 text-sm font-medium" id="kpi-inventory-items">0 items</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Inventory Value</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-inventory-value">€0.00</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <span class="text-red-500 text-sm font-medium badge-pulse" id="kpi-dead-alert">Action needed</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Dead Stock</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-dead-stock">0</p>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Active Tickets -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Active Service Tickets</h3>
                        <div id="dashboard-tickets" class="space-y-3">
                            <p class="text-slate-400 text-center py-8">No active tickets</p>
                        </div>
                    </div>
                    
                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Recent Transactions</h3>
                        <div id="dashboard-transactions" class="space-y-3">
                            <p class="text-slate-400 text-center py-8">No transactions yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Repair Activity -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Recent Repair Activity</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Ticket</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Device</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Customer</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Status</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-repair-activity" class="divide-y divide-slate-100">
                                <tr><td colspan="5" class="text-center py-8 text-slate-400">No recent activity</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Inventory Aging Overview -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Inventory Aging Overview</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-3xl font-bold text-green-600" id="aging-fresh">0</div>
                            <div class="text-sm text-green-700 mt-1">Fresh (0-30 days)</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-3xl font-bold text-yellow-600" id="aging-slow">0</div>
                            <div class="text-sm text-yellow-700 mt-1">Slow (31-60 days)</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-3xl font-bold text-red-600" id="aging-dead">0</div>
                            <div class="text-sm text-red-700 mt-1">Dead (60+ days)</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory View -->
            <div id="view-inventory" class="view hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Inventory</h2>
                        <p class="text-slate-500 mt-1">Manage your stock and pricing</p>
                    </div>
                    <div class="flex gap-3">
                        <select id="inventory-filter-status" onchange="InventoryUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Status</option>
                            <option value="available">Available</option>
                            <option value="reserved">Reserved</option>
                            <option value="sold">Sold</option>
                        </select>
                        <select id="inventory-filter-aging" onchange="InventoryUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Aging</option>
                            <option value="fresh">Fresh</option>
                            <option value="slow">Slow</option>
                            <option value="dead">Dead</option>
                        </select>
                        <input type="text" id="inventory-search" placeholder="Search inventory..." onkeyup="InventoryUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64">
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Item</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Serial</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Grade</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Age</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Buy Price</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Current Price</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Status</th>
                                <th class="text-right px-6 py-4 text-sm font-semibold text-slate-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="8" class="text-center py-12 text-slate-400">No inventory items</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trade Engine View -->
            <div id="view-trade" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Trade Engine</h2>
                    <p class="text-slate-500 mt-1">Buy and sell inventory items</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Buy Form -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Buyback / Add Inventory
                        </h3>
                        <form id="buy-form" onsubmit="TradeEngine.handleBuy(event)" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Type *</label>
                                    <select id="buy-type" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select type</option>
                                        <option value="phone">Phone</option>
                                        <option value="tablet">Tablet</option>
                                        <option value="laptop">Laptop</option>
                                        <option value="console">Game Console</option>
                                        <option value="accessory">Accessory</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Brand *</label>
                                    <input type="text" id="buy-brand" required placeholder="e.g., Apple, Samsung" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Model *</label>
                                    <input type="text" id="buy-model" required placeholder="e.g., iPhone 14 Pro" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Serial Number *</label>
                                    <input type="text" id="buy-serial" required placeholder="Unique identifier" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Source *</label>
                                    <select id="buy-source" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select source</option>
                                        <option value="walk-in">Walk-in Customer</option>
                                        <option value="online">Online Purchase</option>
                                        <option value="auction">Auction</option>
                                        <option value="wholesale">Wholesale</option>
                                        <option value="trade-in">Trade-in</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Seller Name</label>
                                    <input type="text" id="buy-seller" placeholder="Seller's name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Buy Price (€) *</label>
                                    <input type="number" id="buy-price" required min="0" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Base Sell Price (€) *</label>
                                    <input type="number" id="buy-sell-price" required min="0" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Visual Grade *</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <label class="flex items-center justify-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <input type="radio" name="buy-grade" value="A" required class="sr-only peer">
                                        <span class="peer-checked:bg-green-500 peer-checked:text-white px-3 py-1 rounded font-medium">A - Mint</span>
                                    </label>
                                    <label class="flex items-center justify-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <input type="radio" name="buy-grade" value="B" class="sr-only peer">
                                        <span class="peer-checked:bg-blue-500 peer-checked:text-white px-3 py-1 rounded font-medium">B - Good</span>
                                    </label>
                                    <label class="flex items-center justify-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <input type="radio" name="buy-grade" value="C" class="sr-only peer">
                                        <span class="peer-checked:bg-yellow-500 peer-checked:text-white px-3 py-1 rounded font-medium">C - Fair</span>
                                    </label>
                                    <label class="flex items-center justify-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                        <input type="radio" name="buy-grade" value="D" class="sr-only peer">
                                        <span class="peer-checked:bg-red-500 peer-checked:text-white px-3 py-1 rounded font-medium">D - Poor</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Specifications</label>
                                <textarea id="buy-specs" rows="2" placeholder="Storage, color, condition notes..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add to Inventory
                            </button>
                        </form>
                    </div>
                    
                    <!-- Sell Form -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Sell Item
                        </h3>
                        <form id="sell-form" onsubmit="TradeEngine.handleSellSearch(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Search Item</label>
                                <div class="flex gap-2">
                                    <input type="text" id="sell-search" placeholder="Serial number or model..." class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                                        Search
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Available Items for Sale -->
                        <div id="sell-items-container" class="mt-6">
                            <h4 class="text-sm font-medium text-slate-700 mb-3">Available Items</h4>
                            <div id="sell-items-list" class="space-y-3 max-h-96 overflow-y-auto">
                                <p class="text-slate-400 text-center py-8">No items available for sale</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Trades -->
                <div class="mt-8 bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Recent Trades</h3>
                    <div id="recent-trades" class="space-y-3">
                        <p class="text-slate-400 text-center py-8">No recent trades</p>
                    </div>
                </div>
            </div>

            <!-- Sell Confirmation Modal Template (will be shown via JS) -->
            <template id="sell-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800">Confirm Sale</h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="bg-slate-50 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-semibold text-slate-800" id="modal-item-name"></p>
                                        <p class="text-sm text-slate-500" id="modal-item-serial"></p>
                                    </div>
                                    <span id="modal-item-grade" class="px-2 py-1 rounded text-xs font-medium"></span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Sell Price (€)</label>
                                    <input type="number" id="modal-sell-price" min="0" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Warranty (months)</label>
                                    <select id="modal-warranty" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="0">No Warranty</option>
                                        <option value="1">1 Month</option>
                                        <option value="3">3 Months</option>
                                        <option value="6" selected>6 Months</option>
                                        <option value="12">12 Months</option>
                                        <option value="24">24 Months</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name</label>
                                <input type="text" id="modal-customer" placeholder="Customer name (optional)" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Buy Price:</span>
                                    <span class="font-medium" id="modal-buy-price">€0.00</span>
                                </div>
                                <div class="flex justify-between text-sm mt-1">
                                    <span class="text-slate-600">Sell Price:</span>
                                    <span class="font-medium" id="modal-sell-price-display">€0.00</span>
                                </div>
                                <div class="flex justify-between text-lg font-bold mt-2 pt-2 border-t border-blue-200">
                                    <span class="text-blue-800">Profit:</span>
                                    <span class="text-green-600" id="modal-profit">€0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t border-slate-200 flex gap-3">
                            <button onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                Cancel
                            </button>
                            <button onclick="TradeEngine.confirmSale()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Confirm Sale
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Price Override Modal Template -->
            <template id="price-override-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800">Override Price</h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="bg-slate-50 rounded-lg p-4">
                                <p class="font-semibold text-slate-800" id="override-item-name"></p>
                                <p class="text-sm text-slate-500" id="override-item-serial"></p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Current Price</label>
                                    <p class="text-lg font-semibold text-slate-800" id="override-current-price">€0.00</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">New Price (€)</label>
                                    <input type="number" id="override-new-price" min="0" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Reason for Override *</label>
                                <textarea id="override-reason" required rows="2" placeholder="Explain why the price is being changed..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>
                        <div class="p-6 border-t border-slate-200 flex gap-3">
                            <button onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                Cancel
                            </button>
                            <button onclick="InventoryUI.confirmPriceOverride()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Update Price
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Item Details Modal Template -->
            <template id="item-details-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-slate-800">Item Details</h3>
                            <button onclick="Modal.close()" class="text-slate-400 hover:text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="p-6" id="item-details-content">
                            <!-- Content populated by JS -->
                        </div>
                    </div>
                </div>
            </template>

            <!-- Service Center View -->
            <div id="view-service" class="view hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Service Center</h2>
                        <p class="text-slate-500 mt-1">Manage repair tickets and service workflow</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="ServiceUI.showPartsModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            Manage Parts
                        </button>
                        <button onclick="ServiceUI.showNewTicketModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            New Ticket
                        </button>
                    </div>
                </div>
                
                <!-- Service Status Overview -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-slate-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-received">0</div>
                        <div class="text-xs text-slate-500 mt-1">Received</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-diagnostics">0</div>
                        <div class="text-xs text-slate-500 mt-1">Diagnostics</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-yellow-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-waiting">0</div>
                        <div class="text-xs text-slate-500 mt-1">Waiting Parts</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-orange-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-repairing">0</div>
                        <div class="text-xs text-slate-500 mt-1">Repairing</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-purple-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-testing">0</div>
                        <div class="text-xs text-slate-500 mt-1">Testing</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-ready">0</div>
                        <div class="text-xs text-slate-500 mt-1">Ready</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-red-400">
                        <div class="text-2xl font-bold text-slate-800" id="status-scrapped">0</div>
                        <div class="text-xs text-slate-500 mt-1">Scrapped</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-3 mb-6">
                    <select id="service-filter-status" onchange="ServiceUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Status</option>
                        <option value="received">Received</option>
                        <option value="diagnostics">Diagnostics</option>
                        <option value="waiting_parts">Waiting for Parts</option>
                        <option value="repairing">Repairing</option>
                        <option value="testing">Testing</option>
                        <option value="ready">Ready</option>
                        <option value="scrapped">Scrapped</option>
                    </select>
                    <select id="service-filter-warranty" onchange="ServiceUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Tickets</option>
                        <option value="warranty">Warranty Claims</option>
                        <option value="regular">Regular Service</option>
                    </select>
                    <input type="text" id="service-search" placeholder="Search tickets..." onkeyup="ServiceUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 flex-1">
                </div>
                
                <!-- Tickets List -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div id="service-tickets-list" class="divide-y divide-slate-100">
                        <div class="text-center py-12 text-slate-400">No service tickets</div>
                    </div>
                </div>
            </div>

            <!-- New Ticket Modal Template -->
            <template id="new-ticket-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800">Create Service Ticket</h3>
                        </div>
                        <form id="new-ticket-form" onsubmit="ServiceUI.handleCreateTicket(event)" class="p-6 space-y-4">
                            <!-- Customer Info -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name *</label>
                                    <input type="text" id="ticket-customer" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Contact (Phone/Email) *</label>
                                    <input type="text" id="ticket-contact" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <!-- Device Info -->
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Device Type *</label>
                                    <select id="ticket-device-type" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select type</option>
                                        <option value="phone">Phone</option>
                                        <option value="tablet">Tablet</option>
                                        <option value="laptop">Laptop</option>
                                        <option value="console">Game Console</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Brand *</label>
                                    <input type="text" id="ticket-brand" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Model *</label>
                                    <input type="text" id="ticket-model" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Serial / IMEI</label>
                                    <input type="text" id="ticket-serial" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Link to Inventory Item</label>
                                    <select id="ticket-linked-item" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">No linked item</option>
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Warranty -->
                            <div class="flex items-center gap-4 p-4 bg-yellow-50 rounded-lg">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="ticket-warranty" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                                    <span class="font-medium text-slate-700">This is a warranty claim</span>
                                </label>
                                <p class="text-sm text-slate-500">(Item was sold by us and is under warranty)</p>
                            </div>
                            
                            <!-- Issue Description -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Issue Description *</label>
                                <textarea id="ticket-issue" required rows="3" placeholder="Describe the problem..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <!-- Visual Condition -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Visual Condition at Intake</label>
                                <textarea id="ticket-condition" rows="2" placeholder="Scratches, dents, damage..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Create Ticket
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </template>

            <!-- Ticket Details Modal Template -->
            <template id="ticket-details-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800" id="ticket-modal-id">SRV-0000</h3>
                                <p class="text-sm text-slate-500" id="ticket-modal-device"></p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="ServiceUI.printIntakeProtocol()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                    </svg>
                                    Print Protocol
                                </button>
                                <button onclick="Modal.close()" class="text-slate-400 hover:text-slate-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <!-- Customer Info -->
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Customer Information</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">Name:</span>
                                            <span class="font-medium" id="ticket-modal-customer"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">Contact:</span>
                                            <span class="font-medium" id="ticket-modal-contact"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Device Info -->
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Device Information</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">Serial/IMEI:</span>
                                            <span class="font-medium" id="ticket-modal-serial"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">Warranty Claim:</span>
                                            <span class="font-medium" id="ticket-modal-warranty"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">Linked Item:</span>
                                            <span class="font-medium" id="ticket-modal-linked"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Issue -->
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Issue Description</h4>
                                    <p class="text-sm text-slate-600" id="ticket-modal-issue"></p>
                                </div>
                                
                                <!-- Add Note -->
                                <div>
                                    <h4 class="font-semibold text-slate-800 mb-3">Add Note</h4>
                                    <div class="flex gap-2">
                                        <input type="text" id="ticket-new-note" placeholder="Add a note..." class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <button onclick="ServiceUI.addNote()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-4 rounded-lg transition-all">
                                            Add
                                        </button>
                                    </div>
                                    <div id="ticket-modal-notes" class="mt-3 space-y-2 max-h-32 overflow-y-auto">
                                        <!-- Notes populated by JS -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Timeline -->
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-3">Status Timeline</h4>
                                <div id="ticket-modal-timeline" class="space-y-4 mb-6">
                                    <!-- Timeline populated by JS -->
                                </div>
                                
                                <!-- Status Update -->
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-800 mb-3">Update Status</h4>
                                    <div class="grid grid-cols-2 gap-2" id="status-buttons">
                                        <!-- Status buttons populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Print Intake Protocol Template -->
            <template id="intake-protocol-template">
                <div class="print-only bg-white p-8 max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-bold">RepairFlow ERP</h1>
                        <h2 class="text-xl mt-2">Service Intake Protocol</h2>
                    </div>
                    <div class="border-2 border-black p-4 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Ticket ID:</strong> <span id="print-ticket-id"></span></div>
                            <div><strong>Date:</strong> <span id="print-date"></span></div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="font-bold border-b border-black pb-1 mb-2">Customer Information</h3>
                        <p><strong>Name:</strong> <span id="print-customer"></span></p>
                        <p><strong>Contact:</strong> <span id="print-contact"></span></p>
                    </div>
                    <div class="mb-6">
                        <h3 class="font-bold border-b border-black pb-1 mb-2">Device Information</h3>
                        <p><strong>Device:</strong> <span id="print-device"></span></p>
                        <p><strong>Serial/IMEI:</strong> <span id="print-serial"></span></p>
                        <p><strong>Warranty Claim:</strong> <span id="print-warranty"></span></p>
                    </div>
                    <div class="mb-6">
                        <h3 class="font-bold border-b border-black pb-1 mb-2">Issue Description</h3>
                        <p id="print-issue"></p>
                    </div>
                    <div class="mb-6">
                        <h3 class="font-bold border-b border-black pb-1 mb-2">Visual Condition at Intake</h3>
                        <p id="print-condition"></p>
                    </div>
                    <div class="mt-12 grid grid-cols-2 gap-8">
                        <div class="border-t border-black pt-2">
                            <p class="text-center">Customer Signature</p>
                        </div>
                        <div class="border-t border-black pt-2">
                            <p class="text-center">Technician Signature</p>
                        </div>
                    </div>
                    <div class="mt-8 text-center text-sm text-gray-500">
                        <p>Track your repair status at: <strong>Open this app → Public Tracking → Enter Ticket ID</strong></p>
                    </div>
                </div>
            </template>

            <!-- Public Tracking View -->
            <div id="view-tracking" class="view hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-800">Track Your Repair</h2>
                        <p class="text-slate-500 mt-2">Enter your ticket ID to check the status of your repair</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-8">
                        <form onsubmit="TrackingUI.handleSearch(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Ticket ID</label>
                                <input type="text" id="tracking-ticket-id" placeholder="e.g., SRV-0001" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Track Status
                            </button>
                        </form>
                        
                        <!-- Tracking Result -->
                        <div id="tracking-result" class="hidden mt-8">
                            <div class="border-t border-slate-200 pt-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-slate-800" id="tracking-device"></h3>
                                        <p class="text-sm text-slate-500" id="tracking-id"></p>
                                    </div>
                                    <span id="tracking-status-badge" class="px-4 py-2 rounded-full text-sm font-medium"></span>
                                </div>
                                
                                <div class="bg-slate-50 rounded-lg p-4 mb-6">
                                    <h4 class="font-medium text-slate-700 mb-2">Current Status</h4>
                                    <p class="text-slate-600" id="tracking-status-description"></p>
                                </div>
                                
                                <!-- Timeline -->
                                <h4 class="font-medium text-slate-700 mb-4">Progress Timeline</h4>
                                <div id="tracking-timeline" class="space-y-4">
                                    <!-- Timeline populated by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Not Found -->
                        <div id="tracking-not-found" class="hidden mt-8">
                            <div class="text-center py-8">
                                <svg class="w-16 h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="text-slate-500">No ticket found with this ID</p>
                                <p class="text-sm text-slate-400 mt-1">Please check the ticket ID and try again</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance View -->
            <div id="view-finance" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Financial Intelligence</h2>
                    <p class="text-slate-500 mt-1">Revenue, profit, and margin analysis</p>
                </div>
                
                <!-- Finance KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-500 text-sm">Total Revenue</span>
                            <span class="text-green-500 text-xs font-medium" id="finance-revenue-trend">↑ 0%</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="finance-total-revenue">€0.00</p>
                        <p class="text-xs text-slate-400 mt-1">From all sales</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-500 text-sm">Total Profit</span>
                            <span class="text-green-500 text-xs font-medium" id="finance-profit-trend">↑ 0%</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="finance-total-profit">€0.00</p>
                        <p class="text-xs text-slate-400 mt-1">Net earnings</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-500 text-sm">Profit Margin</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="finance-margin">0%</p>
                        <p class="text-xs text-slate-400 mt-1">Average margin on sales</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-500 text-sm">Inventory Value</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="finance-inventory-value">€0.00</p>
                        <p class="text-xs text-slate-400 mt-1">Current stock value</p>
                    </div>
                </div>
                
                <!-- Revenue by Period -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Revenue by Period</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">Today</span>
                                <span class="font-semibold text-slate-800" id="finance-today">€0.00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">This Week</span>
                                <span class="font-semibold text-slate-800" id="finance-week">€0.00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">This Month</span>
                                <span class="font-semibold text-slate-800" id="finance-month">€0.00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">This Year</span>
                                <span class="font-semibold text-slate-800" id="finance-year">€0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Transaction Summary</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700">Total Items Sold</span>
                                <span class="font-semibold text-green-800" id="finance-items-sold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700">Total Items Bought</span>
                                <span class="font-semibold text-blue-800" id="finance-items-bought">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                                <span class="text-purple-700">Average Sale Price</span>
                                <span class="font-semibold text-purple-800" id="finance-avg-sale">€0.00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                                <span class="text-orange-700">Average Profit per Item</span>
                                <span class="font-semibold text-orange-800" id="finance-avg-profit">€0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transaction Ledger -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-800">Transaction Ledger</h3>
                        <div class="flex gap-2">
                            <select id="ledger-filter-type" onchange="FinanceUI.applyFilters()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Types</option>
                                <option value="BUY">Purchases</option>
                                <option value="SELL">Sales</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Date</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Type</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Description</th>
                                    <th class="text-right px-4 py-3 text-sm font-semibold text-slate-600">Amount</th>
                                    <th class="text-right px-4 py-3 text-sm font-semibold text-slate-600">Profit</th>
                                </tr>
                            </thead>
                            <tbody id="ledger-table-body" class="divide-y divide-slate-100">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-slate-400">No transactions yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Forecast View -->
            <div id="view-forecast" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Forecasting Engine</h2>
                    <p class="text-slate-500 mt-1">Predictive analytics based on historical data</p>
                </div>
                
                <!-- Forecast KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="text-slate-500 text-sm">Avg. Days to Sell</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="forecast-avg-days">0</p>
                        <p class="text-xs text-slate-400 mt-1">Average time to sell an item</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <span class="text-slate-500 text-sm">Sell-Through Rate</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="forecast-sell-through">0%</p>
                        <p class="text-xs text-slate-400 mt-1">% of inventory sold per month</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <span class="text-slate-500 text-sm">Days to Clear</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="forecast-days-clear">0</p>
                        <p class="text-xs text-slate-400 mt-1">Estimated days to sell all stock</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="text-slate-500 text-sm">30-Day Forecast</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="forecast-30day">€0.00</p>
                        <p class="text-xs text-slate-400 mt-1">Predicted revenue next 30 days</p>
                    </div>
                </div>
                
                <!-- Risk Analysis -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Inventory Risk Analysis</h3>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-3xl font-bold text-green-600" id="risk-low">0</div>
                            <div class="text-sm text-green-700 mt-1">Low Risk</div>
                            <div class="text-xs text-green-600 mt-1">Fast movers</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-3xl font-bold text-yellow-600" id="risk-medium">0</div>
                            <div class="text-sm text-yellow-700 mt-1">Medium Risk</div>
                            <div class="text-xs text-yellow-600 mt-1">Consider repricing</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-3xl font-bold text-red-600" id="risk-high">0</div>
                            <div class="text-sm text-red-700 mt-1">High Risk</div>
                            <div class="text-xs text-red-600 mt-1">Action required</div>
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Forecast Table -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Per-Item Forecast</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Item</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Age</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Current Price</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Auto Discount</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Risk Score</th>
                                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Est. Days to Sell</th>
                                </tr>
                            </thead>
                            <tbody id="forecast-table-body" class="divide-y divide-slate-100">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-slate-400">No inventory items</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Audit Log View -->
            <div id="view-audit" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Audit Log</h2>
                    <p class="text-slate-500 mt-1">Immutable record of all system events</p>
                </div>
                
                <!-- Audit Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-slate-800" id="audit-total">0</div>
                        <div class="text-sm text-slate-500 mt-1">Total Events</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-blue-600" id="audit-inventory">0</div>
                        <div class="text-sm text-slate-500 mt-1">Inventory Events</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-purple-600" id="audit-service">0</div>
                        <div class="text-sm text-slate-500 mt-1">Service Events</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-green-600" id="audit-finance">0</div>
                        <div class="text-sm text-slate-500 mt-1">Finance Events</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-3 mb-6">
                    <select id="audit-filter-type" onchange="AuditUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Event Types</option>
                        <option value="inventory">Inventory</option>
                        <option value="service">Service</option>
                        <option value="finance">Finance</option>
                        <option value="system">System</option>
                    </select>
                    <select id="audit-filter-action" onchange="AuditUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Actions</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="status_change">Status Change</option>
                        <option value="price_change">Price Change</option>
                    </select>
                    <input type="text" id="audit-search" placeholder="Search events..." onkeyup="AuditUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 flex-1">
                </div>
                
                <!-- Audit Timeline -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div id="audit-timeline" class="space-y-4">
                        <div class="text-center py-12 text-slate-400">No audit events recorded</div>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore View -->
            <div id="view-backup" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Backup & Restore</h2>
                    <p class="text-slate-500 mt-1">Manage your data backups</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Backup Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-slate-800">Create Backup</h3>
                                <p class="text-sm text-slate-500">Download a complete backup of all data</p>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 rounded-lg p-4 mb-6">
                            <h4 class="font-medium text-slate-700 mb-3">Backup will include:</h4>
                            <ul class="space-y-2 text-sm text-slate-600">
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span>All inventory items (<span id="backup-inventory-count">0</span> items)</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span>All service tickets (<span id="backup-ticket-count">0</span> tickets)</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span>All transactions (<span id="backup-transaction-count">0</span> records)</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span>Complete audit log (<span id="backup-audit-count">0</span> entries)</span>
                                </li>
                            </ul>
                        </div>
                        
                        <button onclick="BackupUI.createBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download Backup
                        </button>
                        
                        <p class="text-xs text-slate-400 mt-4 text-center">
                            Backup file will be downloaded as JSON
                        </p>
                    </div>
                    
                    <!-- Restore Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                                <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-slate-800">Restore Backup</h3>
                                <p class="text-sm text-slate-500">Restore data from a backup file</p>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 rounded-lg p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div>
                                    <h4 class="font-medium text-red-800">Warning</h4>
                                    <p class="text-sm text-red-600 mt-1">Restoring a backup will completely replace all existing data. This action cannot be undone.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center mb-4">
                            <input type="file" id="restore-file" accept=".json" onchange="BackupUI.handleFileSelect(event)" class="hidden">
                            <label for="restore-file" class="cursor-pointer">
                                <svg class="w-12 h-12 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-slate-600 font-medium">Click to select backup file</p>
                                <p class="text-sm text-slate-400 mt-1">or drag and drop</p>
                            </label>
                        </div>
                        
                        <div id="restore-preview" class="hidden mb-4">
                            <div class="bg-slate-50 rounded-lg p-4">
                                <h4 class="font-medium text-slate-700 mb-3">Backup Preview:</h4>
                                <ul class="space-y-2 text-sm text-slate-600">
                                    <li>Version: <span id="preview-version" class="font-medium"></span></li>
                                    <li>Created: <span id="preview-date" class="font-medium"></span></li>
                                    <li>Inventory: <span id="preview-inventory" class="font-medium"></span> items</li>
                                    <li>Tickets: <span id="preview-tickets" class="font-medium"></span> records</li>
                                    <li>Transactions: <span id="preview-transactions" class="font-medium"></span> records</li>
                                </ul>
                            </div>
                        </div>
                        
                        <button id="restore-btn" onclick="BackupUI.confirmRestore()" disabled class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Restore Backup
                        </button>
                    </div>
                </div>
                
                <!-- Data Management -->
                <div class="mt-8 bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Data Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <h4 class="font-medium text-slate-700 mb-2">Storage Used</h4>
                            <p class="text-2xl font-bold text-slate-800" id="storage-used">0 KB</p>
                            <p class="text-xs text-slate-500 mt-1">of 5 MB localStorage limit</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <h4 class="font-medium text-slate-700 mb-2">Last Backup</h4>
                            <p class="text-lg font-medium text-slate-800" id="last-backup">Never</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <h4 class="font-medium text-slate-700 mb-2">Data Integrity</h4>
                            <p class="text-lg font-medium text-green-600" id="data-integrity">✓ Valid</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <button onclick="BackupUI.clearAllData()" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Clear All Data
                        </button>
                        <p class="text-xs text-slate-400 mt-2">This will permanently delete all data. Make sure to create a backup first.</p>
                    </div>
                </div>
            </div>

            <!-- Confirm Restore Modal Template -->
            <template id="confirm-restore-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-red-600">⚠️ Confirm Restore</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-slate-600 mb-4">Are you sure you want to restore this backup? This will:</p>
                            <ul class="space-y-2 text-sm text-slate-600 mb-6">
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Delete all current data
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Replace with backup data
                                </li>
                                <li class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    This cannot be undone
                                </li>
                            </ul>
                            <p class="text-sm text-slate-500">Type <strong>RESTORE</strong> to confirm:</p>
                            <input type="text" id="restore-confirm-input" placeholder="Type RESTORE" class="w-full mt-2 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="p-6 border-t border-slate-200 flex gap-3">
                            <button onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                Cancel
                            </button>
                            <button onclick="BackupUI.executeRestore()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Restore
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Parts Management Modal Template -->
            <template id="parts-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-slate-800">Parts Catalog</h3>
                            <button onclick="Modal.close()" class="text-slate-400 hover:text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="p-6">
                            <!-- Add Part Form -->
                            <div class="bg-slate-50 rounded-lg p-4 mb-6">
                                <h4 class="font-semibold text-slate-800 mb-3">Add New Part</h4>
                                <form id="add-part-form" onsubmit="ServiceUI.handleAddPart(event)" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div>
                                        <input type="text" id="part-name" required placeholder="Part Name *" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                    </div>
                                    <div>
                                        <input type="text" id="part-sku" placeholder="SKU" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                    </div>
                                    <div>
                                        <select id="part-category" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                            <option value="screen">Screen</option>
                                            <option value="battery">Battery</option>
                                            <option value="camera">Camera</option>
                                            <option value="speaker">Speaker</option>
                                            <option value="connector">Connector</option>
                                            <option value="button">Button</option>
                                            <option value="general">General</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="number" id="part-cost" required min="0" step="0.01" placeholder="Cost €" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                        <input type="number" id="part-sell" required min="0" step="0.01" placeholder="Sell €" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                        <input type="number" id="part-stock" min="0" placeholder="Qty" class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Add</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Parts List -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Part Name</th>
                                            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">SKU</th>
                                            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Category</th>
                                            <th class="text-right px-4 py-3 text-sm font-semibold text-slate-600">Cost</th>
                                            <th class="text-right px-4 py-3 text-sm font-semibold text-slate-600">Sell Price</th>
                                            <th class="text-right px-4 py-3 text-sm font-semibold text-slate-600">Margin</th>
                                            <th class="text-center px-4 py-3 text-sm font-semibold text-slate-600">Stock</th>
                                            <th class="text-right px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="parts-table-body" class="divide-y divide-slate-100">
                                        <tr><td colspan="8" class="text-center py-8 text-slate-400">No parts in catalog</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Parts Inventory View -->
            <div id="view-parts-inventory" class="view hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Parts Inventory</h2>
                        <p class="text-slate-500 mt-1">Manage iPhone parts stock by device and part type</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="PartsInventoryUI.showAddStockModal()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Stock
                        </button>
                        <button onclick="PartsInventoryUI.initializeDefaultParts()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Initialize Parts Catalog
                        </button>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-slate-800" id="parts-total-items">0</div>
                        <div class="text-sm text-slate-500 mt-1">Total Part Types</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-green-600" id="parts-in-stock">0</div>
                        <div class="text-sm text-slate-500 mt-1">Parts In Stock</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-red-600" id="parts-out-of-stock">0</div>
                        <div class="text-sm text-slate-500 mt-1">Out of Stock</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="text-3xl font-bold text-blue-600" id="parts-total-value">€0</div>
                        <div class="text-sm text-slate-500 mt-1">Total Value</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Device Type</label>
                            <select id="parts-filter-type" onchange="PartsInventoryUI.onDeviceTypeFilterChange()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Types</option>
                                <option value="phone">📱 Phones</option>
                                <option value="console">🎮 Gaming Consoles</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Device</label>
                            <select id="parts-filter-device" onchange="PartsInventoryUI.applyFilters()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Devices</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Part Category</label>
                            <select id="parts-filter-category" onchange="PartsInventoryUI.applyFilters()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Stock Status</label>
                            <select id="parts-filter-stock" onchange="PartsInventoryUI.applyFilters()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All</option>
                                <option value="in_stock">In Stock</option>
                                <option value="low_stock">Low Stock (≤5)</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
                            <input type="text" id="parts-filter-search" placeholder="Search parts..." onkeyup="PartsInventoryUI.applyFilters()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Parts Table -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Device</th>
                                    <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Part</th>
                                    <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Category</th>
                                    <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Quality</th>
                                    <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Color</th>
                                    <th class="text-center px-6 py-4 text-sm font-semibold text-slate-600">Qty</th>
                                    <th class="text-right px-6 py-4 text-sm font-semibold text-slate-600">Cost</th>
                                    <th class="text-right px-6 py-4 text-sm font-semibold text-slate-600">Sell Price</th>
                                    <th class="text-right px-6 py-4 text-sm font-semibold text-slate-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="parts-inventory-table-body" class="divide-y divide-slate-100">
                                <tr>
                                    <td colspan="9" class="text-center py-12 text-slate-400">No parts in inventory. Click "Initialize Parts Catalog" to add default iPhone parts.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add Stock Modal Template -->
            <template id="add-stock-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800">Add/Update Part Stock</h3>
                        </div>
                        <form id="add-stock-form" onsubmit="PartsInventoryUI.handleAddStock(event)" class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Device *</label>
                                    <select id="stock-device" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Device</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Part Type *</label>
                                    <select id="stock-part-type" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Part Type</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Quality *</label>
                                    <select id="stock-quality" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="original">Original (OEM)</option>
                                        <option value="refurbished">Refurbished</option>
                                        <option value="aftermarket_high">Aftermarket High Quality</option>
                                        <option value="aftermarket_standard">Aftermarket Standard</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Color</label>
                                    <select id="stock-color" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">N/A</option>
                                        <option value="black">Black</option>
                                        <option value="white">White</option>
                                        <option value="gold">Gold</option>
                                        <option value="silver">Silver</option>
                                        <option value="space_gray">Space Gray</option>
                                        <option value="midnight">Midnight</option>
                                        <option value="starlight">Starlight</option>
                                        <option value="blue">Blue</option>
                                        <option value="red">Red (PRODUCT RED)</option>
                                        <option value="green">Green</option>
                                        <option value="purple">Purple</option>
                                        <option value="yellow">Yellow</option>
                                        <option value="pink">Pink</option>
                                        <option value="natural_titanium">Natural Titanium</option>
                                        <option value="blue_titanium">Blue Titanium</option>
                                        <option value="white_titanium">White Titanium</option>
                                        <option value="black_titanium">Black Titanium</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Quantity *</label>
                                    <input type="number" id="stock-quantity" required min="0" placeholder="0" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Cost Price (€) *</label>
                                    <input type="number" id="stock-cost" required min="0" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Sell Price (€) *</label>
                                    <input type="number" id="stock-sell" required min="0" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Supplier/Notes</label>
                                <textarea id="stock-notes" rows="2" placeholder="Supplier name, batch number, etc." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Add/Update Stock
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </template>

            <!-- Edit Part Modal Template -->
            <template id="edit-part-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800">Edit Part</h3>
                        </div>
                        <form id="edit-part-form" onsubmit="PartsInventoryUI.handleEditPart(event)" class="p-6 space-y-4">
                            <div class="bg-slate-50 rounded-lg p-4">
                                <p class="font-semibold text-slate-800" id="edit-part-name"></p>
                                <p class="text-sm text-slate-500" id="edit-part-device"></p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                                    <input type="number" id="edit-quantity" min="0" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Add/Remove</label>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="PartsInventoryUI.adjustQuantity(-1)" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-4 rounded-lg">-</button>
                                        <button type="button" onclick="PartsInventoryUI.adjustQuantity(1)" class="flex-1 bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 px-4 rounded-lg">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Cost Price (€)</label>
                                    <input type="number" id="edit-cost" min="0" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Sell Price (€)</label>
                                    <input type="number" id="edit-sell" min="0" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </template>

            <!-- Public Trade-In View (No login required) -->
            <div id="view-public-tradein" class="view hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-800">Trade-In Your Device</h2>
                        <p class="text-slate-500 mt-2">Get a quote for your old device and trade it in for cash</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-8">
                        <form id="public-tradein-form" onsubmit="PublicTradeInUI.handleSubmit(event)" class="space-y-6">
                            <!-- Personal Information -->
                            <div class="border-b border-slate-200 pb-6">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Personal Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Full Name *</label>
                                        <input type="text" id="tradein-name" required placeholder="Your full name" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">ID Number (Občiansky preukaz) *</label>
                                        <input type="text" id="tradein-id-number" required placeholder="e.g., AB123456" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Email *</label>
                                        <input type="email" id="tradein-email" required placeholder="your@email.com" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Phone *</label>
                                        <input type="tel" id="tradein-phone" required placeholder="+421..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Device Information -->
                            <div class="border-b border-slate-200 pb-6">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Device Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Device Type *</label>
                                        <select id="tradein-device-type" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="">Select type</option>
                                            <option value="iphone">iPhone</option>
                                            <option value="ipad">iPad</option>
                                            <option value="macbook">MacBook</option>
                                            <option value="android">Android Phone</option>
                                            <option value="tablet">Android Tablet</option>
                                            <option value="laptop">Other Laptop</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Brand & Model *</label>
                                        <input type="text" id="tradein-model" required placeholder="e.g., iPhone 13 Pro 256GB" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">IMEI / Serial Number</label>
                                        <input type="text" id="tradein-imei" placeholder="Optional" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Condition *</label>
                                        <select id="tradein-condition" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="">Select condition</option>
                                            <option value="excellent">Excellent - Like new</option>
                                            <option value="good">Good - Minor scratches</option>
                                            <option value="fair">Fair - Visible wear</option>
                                            <option value="poor">Poor - Significant damage</option>
                                            <option value="broken">Broken / Not working</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Additional Details</label>
                                    <textarea id="tradein-details" rows="3" placeholder="Describe any issues, accessories included, etc." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Photo Upload -->
                            <div class="border-b border-slate-200 pb-6">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Device Photo *</h3>
                                <p class="text-sm text-slate-500 mb-4">Please upload a clear photo of your device (front and back if possible)</p>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center">
                                    <input type="file" id="tradein-photo" accept="image/*" multiple required onchange="PublicTradeInUI.handlePhotoSelect(event)" class="hidden">
                                    <label for="tradein-photo" class="cursor-pointer">
                                        <svg class="w-12 h-12 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <p class="text-slate-600 font-medium">Click to upload photos</p>
                                        <p class="text-sm text-slate-400 mt-1">PNG, JPG up to 10MB each</p>
                                    </label>
                                </div>
                                <div id="tradein-photo-preview" class="mt-4 grid grid-cols-3 gap-2"></div>
                            </div>
                            
                            <!-- Delivery Method -->
                            <div class="border-b border-slate-200 pb-6">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Delivery Method *</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <label class="flex items-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer hover:border-green-500 transition-all">
                                        <input type="radio" name="tradein-delivery" value="in_person" required class="w-5 h-5 text-green-600 focus:ring-green-500">
                                        <div class="ml-4">
                                            <p class="font-medium text-slate-800">In Person</p>
                                            <p class="text-sm text-slate-500">Visit our store to drop off</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer hover:border-green-500 transition-all">
                                        <input type="radio" name="tradein-delivery" value="shipping" class="w-5 h-5 text-green-600 focus:ring-green-500">
                                        <div class="ml-4">
                                            <p class="font-medium text-slate-800">Ship to Us</p>
                                            <p class="text-sm text-slate-500">We'll send a prepaid label</p>
                                        </div>
                                    </label>
                                </div>
                                <div id="shipping-address-section" class="mt-4 hidden">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Your Address for Shipping Label</label>
                                    <textarea id="tradein-address" rows="2" placeholder="Full shipping address" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Payment Information -->
                            <div class="pb-6">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Payment Information *</h3>
                                <p class="text-sm text-slate-500 mb-4">We will transfer the agreed amount to your bank account</p>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">IBAN *</label>
                                    <input type="text" id="tradein-iban" required placeholder="SK00 0000 0000 0000 0000 0000" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 font-mono">
                                    <p class="text-xs text-slate-400 mt-1">Slovak IBAN format: SK followed by 22 digits</p>
                                </div>
                            </div>
                            
                            <!-- Terms -->
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" id="tradein-terms" required class="w-5 h-5 mt-0.5 text-green-600 focus:ring-green-500 rounded">
                                    <span class="text-sm text-slate-600">
                                        I confirm that I am the legal owner of this device, and I agree to the trade-in terms and conditions. I understand that the final offer may change after inspection.
                                    </span>
                                </label>
                            </div>
                            
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-2 text-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Submit Trade-In Request
                            </button>
                        </form>
                        
                        <!-- Success Message -->
                        <div id="tradein-success" class="hidden text-center py-12">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-800 mb-2">Request Submitted!</h3>
                            <p class="text-slate-600 mb-4">Your trade-in request has been received.</p>
                            <p class="text-sm text-slate-500 mb-2">Reference: <strong id="tradein-ref-number" class="font-mono"></strong></p>
                            <p class="text-sm text-slate-500">We will review your request and contact you within 24-48 hours with an offer.</p>
                            <button onclick="PublicTradeInUI.resetForm()" class="mt-6 text-green-600 hover:text-green-800 font-medium">Submit Another Request →</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade-In Requests Management (Admin) -->
            <div id="view-tradein-requests" class="view hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Trade-In Requests</h2>
                        <p class="text-slate-500 mt-1">Review and approve customer trade-in submissions</p>
                    </div>
                </div>
                
                <!-- Status Overview -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-yellow-400">
                        <div class="text-2xl font-bold text-slate-800" id="tradein-status-pending">0</div>
                        <div class="text-xs text-slate-500 mt-1">Pending Review</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-400">
                        <div class="text-2xl font-bold text-slate-800" id="tradein-status-quoted">0</div>
                        <div class="text-xs text-slate-500 mt-1">Quote Sent</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-purple-400">
                        <div class="text-2xl font-bold text-slate-800" id="tradein-status-received">0</div>
                        <div class="text-xs text-slate-500 mt-1">Device Received</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-400">
                        <div class="text-2xl font-bold text-slate-800" id="tradein-status-completed">0</div>
                        <div class="text-xs text-slate-500 mt-1">Completed</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-red-400">
                        <div class="text-2xl font-bold text-slate-800" id="tradein-status-rejected">0</div>
                        <div class="text-xs text-slate-500 mt-1">Rejected</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-3 mb-6">
                    <select id="tradein-filter-status" onchange="TradeInRequestsUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Status</option>
                        <option value="pending">Pending Review</option>
                        <option value="quoted">Quote Sent</option>
                        <option value="accepted">Quote Accepted</option>
                        <option value="received">Device Received</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <input type="text" id="tradein-search" placeholder="Search by name, email, device..." onkeyup="TradeInRequestsUI.applyFilters()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 flex-1">
                </div>
                
                <!-- Requests List -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div id="tradein-requests-list" class="divide-y divide-slate-100">
                        <div class="text-center py-12 text-slate-400">No trade-in requests</div>
                    </div>
                </div>
            </div>

            <!-- Trade-In Details Modal Template -->
            <template id="tradein-details-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800" id="tradein-modal-ref">TRD-0000</h3>
                                <p class="text-sm text-slate-500" id="tradein-modal-date"></p>
                            </div>
                            <button onclick="Modal.close()" class="text-slate-400 hover:text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left Column - Customer & Device Info -->
                            <div class="space-y-6">
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Customer Information</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span class="text-slate-500">Name:</span><span class="font-medium" id="tradein-modal-name"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">ID Number:</span><span class="font-medium font-mono" id="tradein-modal-idnum"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">Email:</span><span class="font-medium" id="tradein-modal-email"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">Phone:</span><span class="font-medium" id="tradein-modal-phone"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">IBAN:</span><span class="font-medium font-mono text-xs" id="tradein-modal-iban"></span></div>
                                    </div>
                                </div>
                                
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Device Information</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span class="text-slate-500">Type:</span><span class="font-medium" id="tradein-modal-type"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">Model:</span><span class="font-medium" id="tradein-modal-model"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">IMEI/Serial:</span><span class="font-medium font-mono" id="tradein-modal-imei"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">Condition:</span><span class="font-medium" id="tradein-modal-condition"></span></div>
                                        <div class="flex justify-between"><span class="text-slate-500">Delivery:</span><span class="font-medium" id="tradein-modal-delivery"></span></div>
                                    </div>
                                </div>
                                
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Additional Details</h4>
                                    <p class="text-sm text-slate-600" id="tradein-modal-details">-</p>
                                </div>
                                
                                <div id="tradein-modal-photos" class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Photos</h4>
                                    <div class="grid grid-cols-2 gap-2" id="tradein-photos-container"></div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Actions -->
                            <div class="space-y-6">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-800 mb-3">Current Status</h4>
                                    <span id="tradein-modal-status" class="px-4 py-2 rounded-full text-sm font-medium"></span>
                                </div>
                                
                                <div class="bg-green-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-green-800 mb-3">Quote / Offer</h4>
                                    <div class="flex gap-2 mb-3">
                                        <input type="number" id="tradein-offer-amount" min="0" step="0.01" placeholder="Offer amount €" class="flex-1 px-4 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <button onclick="TradeInRequestsUI.sendQuote()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg">Send Quote</button>
                                    </div>
                                    <p class="text-sm text-green-600">Current offer: <strong id="tradein-current-offer">€0.00</strong></p>
                                </div>
                                
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Update Status</h4>
                                    <div class="grid grid-cols-2 gap-2" id="tradein-status-buttons"></div>
                                </div>
                                
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-slate-800 mb-3">Notes</h4>
                                    <div class="flex gap-2 mb-3">
                                        <input type="text" id="tradein-new-note" placeholder="Add note..." class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <button onclick="TradeInRequestsUI.addNote()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-4 rounded-lg">Add</button>
                                    </div>
                                    <div id="tradein-modal-notes" class="space-y-2 max-h-32 overflow-y-auto"></div>
                                </div>
                                
                                <div class="flex gap-3">
                                    <button onclick="TradeInRequestsUI.addToInventory()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg">
                                        Add to Inventory
                                    </button>
                                    <button onclick="TradeInRequestsUI.rejectRequest()" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 font-medium py-3 px-4 rounded-lg">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Bulk Add Device Parts Modal Template -->
            <template id="bulk-add-parts-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800">🎮 Add Device for Parts</h3>
                            <p class="text-sm text-slate-500 mt-1">Buy a whole device for parts - uncheck any faulty/missing parts</p>
                        </div>
                        <form id="bulk-add-parts-form" onsubmit="BulkPartsUI.handleSubmit(event)" class="p-6 space-y-6">
                            <!-- Device Selection -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Device Type *</label>
                                    <select id="bulk-device-type" required onchange="BulkPartsUI.onDeviceTypeChange()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select type...</option>
                                        <option value="console">Gaming Console</option>
                                        <option value="phone">Phone</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Device Model *</label>
                                    <select id="bulk-device-model" required onchange="BulkPartsUI.onDeviceModelChange()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select device first...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Purchase Price (€) *</label>
                                    <input type="number" id="bulk-purchase-price" required min="0" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Quality</label>
                                    <select id="bulk-quality" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="original">Original (OEM)</option>
                                        <option value="refurbished">Refurbished</option>
                                        <option value="aftermarket_high">Aftermarket High</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Supplier/Source</label>
                                    <input type="text" id="bulk-supplier" placeholder="Supplier name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                                <button type="button" onclick="BulkPartsUI.selectAllParts()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">✓ Select All</button>
                                <span class="text-slate-300">|</span>
                                <button type="button" onclick="BulkPartsUI.deselectAllParts()" class="text-sm text-red-600 hover:text-red-800 font-medium">✗ Deselect All</button>
                                <span class="text-slate-300">|</span>
                                <span class="text-sm text-slate-500">Selected: <strong id="bulk-selected-count">0</strong> parts</span>
                            </div>
                            
                            <!-- Parts Checklist by Category -->
                            <div id="bulk-parts-checklist" class="space-y-4">
                                <p class="text-slate-400 text-center py-8">Select a device to see available parts</p>
                            </div>
                            
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button type="button" onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add Selected Parts to Inventory
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </template>

            <!-- Users Management View (Master Admin Only) -->
            <div id="view-users" class="view hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">User Management</h2>
                        <p class="text-slate-500 mt-1">Manage system users and their access</p>
                    </div>
                    <button onclick="UsersUI.showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add User
                    </button>
                </div>
                
                <!-- Users Table -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">User</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Username</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Role</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Last Login</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-slate-600">Status</th>
                                <th class="text-right px-6 py-4 text-sm font-semibold text-slate-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="6" class="text-center py-12 text-slate-400">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit User Modal Template -->
            <template id="add-user-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800" id="user-modal-title">Add New User</h3>
                        </div>
                        <form id="user-form" onsubmit="UsersUI.handleSaveUser(event)" class="p-6 space-y-4">
                            <input type="hidden" id="user-edit-id" value="">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Full Name *</label>
                                <input type="text" id="user-name" required placeholder="Full name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Username *</label>
                                <input type="text" id="user-username" required placeholder="Username for login" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Password <span id="password-hint">(required)</span></label>
                                <input type="password" id="user-password" placeholder="Password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Role *</label>
                                <select id="user-role" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="admin">Admin</option>
                                    <option value="master_admin">Master Admin</option>
                                </select>
                            </div>
                            <div id="user-active-field" class="hidden">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="user-active" checked class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">Account Active</span>
                                </label>
                            </div>
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Save User
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </template>

            <!-- Settings View -->
            <div id="view-settings" class="view hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Settings</h2>
                    <p class="text-slate-500 mt-1">Configure system preferences and notifications</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Email Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Email Configuration
                        </h3>
                        <form id="email-settings-form" onsubmit="SettingsUI.saveEmailSettings(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Company Email</label>
                                <input type="email" id="settings-company-email" placeholder="your-shop@email.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-slate-400 mt-1">This email will be shown in customer notifications</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Company Name</label>
                                <input type="text" id="settings-company-name" placeholder="Your Shop Name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Company Phone</label>
                                <input type="tel" id="settings-company-phone" placeholder="+421 XXX XXX XXX" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Company Address</label>
                                <textarea id="settings-company-address" rows="2" placeholder="Street, City, ZIP" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Save Email Settings
                            </button>
                        </form>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            Email Notifications
                        </h3>
                        <div class="space-y-4">
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-all">
                                <div>
                                    <p class="font-medium text-slate-800">Trade-In Quote Notifications</p>
                                    <p class="text-sm text-slate-500">Email customers when a quote is sent</p>
                                </div>
                                <input type="checkbox" id="settings-notify-tradein" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-all">
                                <div>
                                    <p class="font-medium text-slate-800">Repair Status Notifications</p>
                                    <p class="text-sm text-slate-500">Email customers when repair status changes</p>
                                </div>
                                <input type="checkbox" id="settings-notify-repair" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-all">
                                <div>
                                    <p class="font-medium text-slate-800">Ready for Pickup Notifications</p>
                                    <p class="text-sm text-slate-500">Email when device is ready for pickup</p>
                                </div>
                                <input type="checkbox" id="settings-notify-ready" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                            
                            <button onclick="SettingsUI.saveNotificationSettings()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Save Notification Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Security
                        </h3>
                        <form id="password-change-form" onsubmit="SettingsUI.changePassword(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Current Password</label>
                                <input type="password" id="settings-current-password" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
                                <input type="password" id="settings-new-password" required minlength="4" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label>
                                <input type="password" id="settings-confirm-password" required minlength="4" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Change Password
                            </button>
                        </form>
                    </div>
                    
                    <!-- Email Templates Preview -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Email Templates
                        </h3>
                        <div class="space-y-3">
                            <button onclick="SettingsUI.previewEmailTemplate('tradein_quote')" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all">
                                <span class="font-medium text-slate-700">Trade-In Quote Email</span>
                                <span class="text-blue-600 text-sm">Preview →</span>
                            </button>
                            <button onclick="SettingsUI.previewEmailTemplate('repair_status')" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all">
                                <span class="font-medium text-slate-700">Repair Status Update Email</span>
                                <span class="text-blue-600 text-sm">Preview →</span>
                            </button>
                            <button onclick="SettingsUI.previewEmailTemplate('ready_pickup')" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-all">
                                <span class="font-medium text-slate-700">Ready for Pickup Email</span>
                                <span class="text-blue-600 text-sm">Preview →</span>
                            </button>
                        </div>
                        <div class="mt-4 p-4 bg-yellow-50 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <strong>Note:</strong> Email notifications are prepared for sending. To enable actual email delivery, configure an email service like SendGrid, Mailgun, or SMTP.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Preview Modal Template -->
            <template id="email-preview-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-slate-800">Email Template Preview</h3>
                            <button onclick="Modal.close()" class="text-slate-400 hover:text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="p-6">
                            <div id="email-preview-content" class="border border-slate-200 rounded-lg p-6 bg-slate-50">
                                <!-- Email preview content populated by JS -->
                            </div>
                        </div>
                        <div class="p-6 border-t border-slate-200">
                            <button onclick="SettingsUI.sendTestEmail()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Send Test Email
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Clear Data Modal Template -->
            <template id="clear-data-modal-template">
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b border-slate-200">
                            <h3 class="text-xl font-bold text-red-600">⚠️ Clear All Data</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-slate-600 mb-4">This will permanently delete:</p>
                            <ul class="space-y-2 text-sm text-slate-600 mb-6">
                                <li>• All inventory items</li>
                                <li>• All service tickets</li>
                                <li>• All transactions</li>
                                <li>• Complete audit history</li>
                            </ul>
                            <p class="text-sm text-slate-500">Type <strong>DELETE ALL</strong> to confirm:</p>
                            <input type="text" id="clear-confirm-input" placeholder="Type DELETE ALL" class="w-full mt-2 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="p-6 border-t border-slate-200 flex gap-3">
                            <button onclick="Modal.close()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-all">
                                Cancel
                            </button>
                            <button onclick="BackupUI.executeClear()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                Delete All
                            </button>
                        </div>
                    </div>
                </div>
            </template>

        </main>
    </div>

    <script>
    // ============================================
    // API CONFIGURATION
    // ============================================
    const API_URL = 'https://erp-phonetech-production.up.railway.app';
    const USE_API = true; // Enable API for multi-device synchronization
    
    // ============================================
    // API SERVICE - Handles all server communication
    // ============================================
    const ApiService = {
        token: null,
        
        init() {
            this.token = sessionStorage.getItem('auth_token');
        },
        
        setToken(token) {
            this.token = token;
            sessionStorage.setItem('auth_token', token);
        },
        
        clearToken() {
            this.token = null;
            sessionStorage.removeItem('auth_token');
        },
        
        getHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (this.token) {
                headers['Authorization'] = `Bearer ${this.token}`;
            }
            return headers;
        },
        
        async request(endpoint, options = {}) {
            const url = `${API_URL}${endpoint}`;
            const config = {
                ...options,
                headers: { ...this.getHeaders(), ...options.headers }
            };
            
            try {
                const response = await fetch(url, config);
                
                if (response.status === 401) {
                    // Token expired or invalid
                    this.clearToken();
                    Auth.logout();
                    throw new Error('Session expired. Please login again.');
                }
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Request failed' }));
                    throw new Error(error.error || 'Request failed');
                }
                
                return await response.json();
            } catch (error) {
                if (error.message === 'Failed to fetch') {
                    console.warn('Network error - using local fallback');
                    return null; // Return null to trigger local fallback
                }
                throw error;
            }
        },
        
        async get(endpoint) {
            return this.request(endpoint, { method: 'GET' });
        },
        
        async post(endpoint, data) {
            return this.request(endpoint, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        },
        
        async put(endpoint, data) {
            return this.request(endpoint, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
        },
        
        async delete(endpoint) {
            return this.request(endpoint, { method: 'DELETE' });
        }
    };
    
    // ============================================
    // MULTI-DEVICE SYNC MODULE
    // Real-time sync across devices using server + BroadcastChannel
    // ============================================
    const SyncManager = {
        channel: null,
        lastSyncTimestamp: 0,
        syncInterval: null,
        SYNC_INTERVAL_MS: 5000, // Check every 5 seconds
        VERSION_KEY: 'repairflow_data_version',
        isSyncing: false,
        pendingChanges: [],
        
        init() {
            // Use BroadcastChannel for same-origin tabs
            if ('BroadcastChannel' in window) {
                this.channel = new BroadcastChannel('repairflow_sync');
                this.channel.onmessage = (event) => this.handleSyncMessage(event);
            }
            
            // Listen for storage events from other tabs/windows
            window.addEventListener('storage', (event) => {
                if (event.key === 'repairflow_erp_data' || event.key === this.VERSION_KEY) {
                    this.handleStorageChange(event);
                }
            });
            
            // Start periodic sync check for cross-device sync via server
            this.startPeriodicSync();
            
            // Sync on visibility change (when user returns to tab)
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    this.checkForUpdates();
                }
            });
            
            // Initialize version
            if (!localStorage.getItem(this.VERSION_KEY)) {
                localStorage.setItem(this.VERSION_KEY, Date.now().toString());
            }
            this.lastSyncTimestamp = parseInt(localStorage.getItem(this.VERSION_KEY)) || 0;
            
            console.log('📡 SyncManager initialized - Multi-device sync enabled');
        },
        
        // Broadcast a data change to other tabs
        broadcastChange(action, data = {}) {
            const version = Date.now();
            localStorage.setItem(this.VERSION_KEY, version.toString());
            this.lastSyncTimestamp = version;
            
            if (this.channel) {
                this.channel.postMessage({
                    action,
                    version,
                    data,
                    timestamp: new Date().toISOString()
                });
            }
        },
        
        // Handle incoming sync messages from other tabs
        handleSyncMessage(event) {
            const { action, version, data } = event.data;
            
            if (version > this.lastSyncTimestamp) {
                console.log('📥 Sync received from another tab:', action);
                this.lastSyncTimestamp = version;
                
                // Refresh UI without full reload
                App.refresh();
                Toast.info('Data updated from another tab');
            }
        },
        
        // Handle localStorage changes from other tabs/windows
        handleStorageChange(event) {
            if (event.key === this.VERSION_KEY) {
                const newVersion = parseInt(event.newValue) || 0;
                if (newVersion > this.lastSyncTimestamp) {
                    console.log('📥 Storage sync detected');
                    this.lastSyncTimestamp = newVersion;
                    App.refresh();
                    Toast.info('Data synchronized');
                }
            }
        },
        
        // Start periodic sync for cross-device
        startPeriodicSync() {
            if (USE_API) {
                // Initial sync when starting
                setTimeout(() => this.pullFromServer(), 1000);
                
                // Periodic sync
                this.syncInterval = setInterval(() => {
                    this.pullFromServer();
                }, this.SYNC_INTERVAL_MS);
            }
        },
        
        // Check for updates when tab becomes visible
        async checkForUpdates() {
            const currentVersion = parseInt(localStorage.getItem(this.VERSION_KEY)) || 0;
            if (currentVersion > this.lastSyncTimestamp) {
                console.log('📥 Updates detected on tab focus');
                this.lastSyncTimestamp = currentVersion;
                App.refresh();
            }
            
            if (USE_API && ApiService.token) {
                await this.pullFromServer();
            }
        },
        
        // Pull latest data from server
        async pullFromServer() {
            if (!USE_API || !ApiService.token || this.isSyncing) return;
            
            this.isSyncing = true;
            try {
                // Fetch inventory from server
                const inventory = await ApiService.get('/api/inventory');
                if (inventory && Array.isArray(inventory)) {
                    // Transform server data to local format
                    const localInventory = inventory.map(item => ({
                        id: item.id.toString(),
                        type: item.type,
                        brand: item.brand,
                        model: item.model,
                        serial: item.serial,
                        source: item.source,
                        seller: item.seller || '',
                        buy: parseFloat(item.buy_price),
                        base_sell_price: parseFloat(item.base_sell_price),
                        current_price: parseFloat(item.current_price),
                        sell: item.sold_price ? parseFloat(item.sold_price) : null,
                        status: item.status,
                        visual: item.visual_grade,
                        specs: item.specs || '',
                        date: item.created_at,
                        warranty_months: item.warranty_months || 0,
                        warranty_expires: item.warranty_expires,
                        sold_date: item.sold_date,
                        sold_to: item.sold_to,
                        price_override: item.price_override_reason ? { reason: item.price_override_reason } : null
                    }));
                    
                    // Update local state
                    const state = State.get();
                    if (JSON.stringify(state.inventory) !== JSON.stringify(localInventory)) {
                        state.inventory = localInventory;
                        State._state = state;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                        this.broadcastChange('inventory_sync');
                        console.log('📥 Inventory synced from server:', localInventory.length, 'items');
                    }
                }
            } catch (error) {
                console.warn('Failed to pull from server:', error.message);
            } finally {
                this.isSyncing = false;
            }
        },
        
        // Push inventory item to server
        async pushToServer(action, itemData) {
            if (!USE_API || !ApiService.token) return null;
            
            try {
                let result;
                switch (action) {
                    case 'add':
                        result = await ApiService.post('/api/inventory', {
                            type: itemData.type,
                            brand: itemData.brand,
                            model: itemData.model,
                            serial: itemData.serial,
                            source: itemData.source,
                            seller: itemData.seller,
                            buy_price: itemData.buy,
                            base_sell_price: itemData.base_sell_price,
                            current_price: itemData.current_price || itemData.base_sell_price,
                            visual_grade: itemData.visual,
                            specs: itemData.specs,
                            status: 'available'
                        });
                        console.log('📤 Inventory item pushed to server:', result?.id);
                        break;
                        
                    case 'update':
                        result = await ApiService.put(`/api/inventory/${itemData.id}`, {
                            current_price: itemData.current_price,
                            status: itemData.status,
                            sold_price: itemData.sell,
                            sold_date: itemData.sold_date,
                            sold_to: itemData.sold_to,
                            warranty_months: itemData.warranty_months,
                            warranty_expires: itemData.warranty_expires,
                            price_override_reason: itemData.price_override?.reason
                        });
                        console.log('📤 Inventory item updated on server:', itemData.id);
                        break;
                        
                    case 'sell':
                        result = await ApiService.post(`/api/inventory/${itemData.id}/sell`, {
                            sold_price: itemData.sell,
                            sold_to: itemData.sold_to,
                            warranty_months: itemData.warranty_months
                        });
                        console.log('📤 Item sold synced to server:', itemData.id);
                        break;
                }
                
                return result;
            } catch (error) {
                console.warn('Failed to push to server:', error.message);
                // Queue for retry later
                this.pendingChanges.push({ action, itemData, timestamp: Date.now() });
                return null;
            }
        },
        
        // Retry pending changes
        async retryPendingChanges() {
            if (this.pendingChanges.length === 0) return;
            
            const changes = [...this.pendingChanges];
            this.pendingChanges = [];
            
            for (const change of changes) {
                await this.pushToServer(change.action, change.itemData);
            }
        },
        
        destroy() {
            if (this.channel) {
                this.channel.close();
            }
            if (this.syncInterval) {
                clearInterval(this.syncInterval);
            }
        }
    };
    
    // ============================================
    // EMBEDDED DATA - All device and parts data
    // ============================================
    const PHONE_DEVICES = [
        { id: "iphone_16_pro_max", name: "iPhone 16 Pro Max", year: 2024 },
        { id: "iphone_16_pro", name: "iPhone 16 Pro", year: 2024 },
        { id: "iphone_16_plus", name: "iPhone 16 Plus", year: 2024 },
        { id: "iphone_16", name: "iPhone 16", year: 2024 },
        { id: "iphone_15_pro_max", name: "iPhone 15 Pro Max", year: 2023 },
        { id: "iphone_15_pro", name: "iPhone 15 Pro", year: 2023 },
        { id: "iphone_15_plus", name: "iPhone 15 Plus", year: 2023 },
        { id: "iphone_15", name: "iPhone 15", year: 2023 },
        { id: "iphone_14_pro_max", name: "iPhone 14 Pro Max", year: 2022 },
        { id: "iphone_14_pro", name: "iPhone 14 Pro", year: 2022 },
        { id: "iphone_14_plus", name: "iPhone 14 Plus", year: 2022 },
        { id: "iphone_14", name: "iPhone 14", year: 2022 },
        { id: "iphone_13_pro_max", name: "iPhone 13 Pro Max", year: 2021 },
        { id: "iphone_13_pro", name: "iPhone 13 Pro", year: 2021 },
        { id: "iphone_13", name: "iPhone 13", year: 2021 },
        { id: "iphone_13_mini", name: "iPhone 13 Mini", year: 2021 },
        { id: "iphone_12_pro_max", name: "iPhone 12 Pro Max", year: 2020 },
        { id: "iphone_12_pro", name: "iPhone 12 Pro", year: 2020 },
        { id: "iphone_12", name: "iPhone 12", year: 2020 },
        { id: "iphone_12_mini", name: "iPhone 12 Mini", year: 2020 },
        { id: "iphone_11_pro_max", name: "iPhone 11 Pro Max", year: 2019 },
        { id: "iphone_11_pro", name: "iPhone 11 Pro", year: 2019 },
        { id: "iphone_11", name: "iPhone 11", year: 2019 },
        { id: "iphone_xs_max", name: "iPhone XS Max", year: 2018 },
        { id: "iphone_xs", name: "iPhone XS", year: 2018 },
        { id: "iphone_xr", name: "iPhone XR", year: 2018 },
        { id: "iphone_x", name: "iPhone X", year: 2017 },
        { id: "iphone_8_plus", name: "iPhone 8 Plus", year: 2017 },
        { id: "iphone_8", name: "iPhone 8", year: 2017 },
        { id: "iphone_se_3rd", name: "iPhone SE (3rd Gen)", year: 2022 },
        { id: "iphone_se_2nd", name: "iPhone SE (2nd Gen)", year: 2020 },
        { id: "iphone_se_1st", name: "iPhone SE (1st Gen)", year: 2016 }
    ];
    const IPHONE_DEVICES = PHONE_DEVICES; // Alias

    const IPHONE_PART_TYPES = [
        { id: "display_oled", name: "Display Assembly OLED", category: "display", hasColor: false },
        { id: "display_lcd", name: "Display Assembly LCD", category: "display", hasColor: false },
        { id: "display_incell", name: "Display Assembly In-Cell", category: "display", hasColor: false },
        { id: "battery", name: "Battery", category: "battery", hasColor: false },
        { id: "housing_back", name: "Back Housing/Frame", category: "housing", hasColor: true },
        { id: "back_glass", name: "Back Glass", category: "back_glass", hasColor: true },
        { id: "rear_camera_module", name: "Rear Camera Module Complete", category: "camera", hasColor: false },
        { id: "front_camera", name: "Front Camera", category: "camera", hasColor: false },
        { id: "charging_port", name: "Charging Port Flex", category: "charging", hasColor: true },
        { id: "ear_speaker", name: "Ear Speaker", category: "speaker", hasColor: false },
        { id: "loudspeaker", name: "Loudspeaker", category: "speaker", hasColor: false },
        { id: "power_button", name: "Power Button Flex", category: "buttons", hasColor: false },
        { id: "volume_buttons", name: "Volume Button Flex", category: "buttons", hasColor: false },
        { id: "face_id_module", name: "Face ID Module", category: "sensors", hasColor: false },
        { id: "taptic_engine", name: "Taptic Engine/Vibrator", category: "other", hasColor: false },
        { id: "logic_board", name: "Logic Board", category: "other", hasColor: false }
    ];

    const QUALITY_TYPES = [
        { id: "original", name: "Original (OEM)", multiplier: 1.0 },
        { id: "refurbished", name: "Refurbished", multiplier: 0.7 },
        { id: "aftermarket_high", name: "Aftermarket High Quality", multiplier: 0.5 },
        { id: "aftermarket_standard", name: "Aftermarket Standard", multiplier: 0.3 }
    ];

    const COLOR_OPTIONS = [
        { id: "black", name: "Black" },
        { id: "white", name: "White" },
        { id: "gold", name: "Gold" },
        { id: "silver", name: "Silver" },
        { id: "space_gray", name: "Space Gray" },
        { id: "midnight", name: "Midnight" },
        { id: "blue", name: "Blue" },
        { id: "red", name: "Red" },
        { id: "green", name: "Green" },
        { id: "purple", name: "Purple" }
    ];

    const CONSOLE_DEVICES = [
        { id: "ps5_standard", name: "PlayStation 5 (Standard)", brand: "Sony", year: 2020 },
        { id: "ps5_digital", name: "PlayStation 5 (Digital)", brand: "Sony", year: 2020 },
        { id: "ps5_slim", name: "PlayStation 5 Slim", brand: "Sony", year: 2023 },
        { id: "ps4_pro", name: "PlayStation 4 Pro", brand: "Sony", year: 2016 },
        { id: "ps4_slim", name: "PlayStation 4 Slim", brand: "Sony", year: 2016 },
        { id: "xbox_series_x", name: "Xbox Series X", brand: "Microsoft", year: 2020 },
        { id: "xbox_series_s", name: "Xbox Series S", brand: "Microsoft", year: 2020 },
        { id: "xbox_one_x", name: "Xbox One X", brand: "Microsoft", year: 2017 },
        { id: "switch_oled", name: "Nintendo Switch OLED", brand: "Nintendo", year: 2021 },
        { id: "switch_standard", name: "Nintendo Switch", brand: "Nintendo", year: 2017 },
        { id: "switch_lite", name: "Nintendo Switch Lite", brand: "Nintendo", year: 2019 }
    ];

    const CONSOLE_PART_TYPES = [
        { id: "power_supply", name: "Power Supply Unit (PSU)", category: "power" },
        { id: "cooling_fan", name: "Cooling Fan", category: "cooling" },
        { id: "heatsink", name: "Heatsink", category: "cooling" },
        { id: "top_shell", name: "Top Shell/Cover", category: "housing" },
        { id: "bottom_shell", name: "Bottom Shell/Cover", category: "housing" },
        { id: "disc_drive", name: "Disc Drive (Complete)", category: "optical" },
        { id: "disc_drive_laser", name: "Disc Drive Laser Lens", category: "optical" },
        { id: "motherboard", name: "Motherboard", category: "board" },
        { id: "hdmi_port", name: "HDMI Port", category: "board" },
        { id: "wifi_module", name: "WiFi/Bluetooth Module", category: "board" },
        { id: "controller_thumbstick", name: "Analog Thumbstick Module", category: "controller" },
        { id: "controller_battery", name: "Controller Battery", category: "controller" },
        { id: "controller_board", name: "Controller Main Board", category: "controller" }
    ];

    const CONSOLE_PART_CATEGORIES = [
        { id: "power", name: "Power & Electrical", icon: "⚡" },
        { id: "cooling", name: "Cooling & Thermal", icon: "❄️" },
        { id: "housing", name: "Housing & Shell", icon: "🏠" },
        { id: "optical", name: "Optical Drive", icon: "💿" },
        { id: "board", name: "Motherboard & Electronics", icon: "🔧" },
        { id: "controller", name: "Controller Parts", icon: "🎮" }
    ];

    const PHONE_PART_CATEGORIES = [
        { id: "display", name: "Display", icon: "📱" },
        { id: "battery", name: "Battery", icon: "🔋" },
        { id: "housing", name: "Housing", icon: "🏠" },
        { id: "back_glass", name: "Back Glass", icon: "🪟" },
        { id: "camera", name: "Camera", icon: "📷" },
        { id: "charging", name: "Charging", icon: "🔌" },
        { id: "speaker", name: "Speaker", icon: "🔊" },
        { id: "buttons", name: "Buttons", icon: "🔘" },
        { id: "sensors", name: "Sensors", icon: "📡" },
        { id: "other", name: "Other", icon: "🔧" }
    ];

    const SERVICE_STATUSES = [
        { key: "received", label: "Received", color: "slate" },
        { key: "diagnostics", label: "Diagnostics", color: "blue" },
        { key: "waiting_parts", label: "Waiting for Parts", color: "yellow" },
        { key: "repairing", label: "Repairing", color: "orange" },
        { key: "testing", label: "Testing", color: "purple" },
        { key: "ready", label: "Ready", color: "green" },
        { key: "scrapped", label: "Scrapped", color: "red" }
    ];

    const TRADEIN_STATUSES = [
        { key: "pending", label: "Pending Review", color: "yellow" },
        { key: "quoted", label: "Quote Sent", color: "blue" },
        { key: "accepted", label: "Quote Accepted", color: "purple" },
        { key: "received", label: "Device Received", color: "indigo" },
        { key: "completed", label: "Completed", color: "green" },
        { key: "rejected", label: "Rejected", color: "red" }
    ];

    const DataLoader = {
        isLoaded: true, // Data is embedded, always loaded
        
        async load() {
            // Data is embedded directly, no need to fetch
            console.log('Data loaded (embedded)');
            return true;
        }
    };

    // ============================================
    // UTILITIES MODULE
    // ============================================
    const Utils = {
        // Generate unique ID
        generateId(prefix = '') {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            return prefix ? `${prefix}-${timestamp}${random}` : `${timestamp}${random}`;
        },
        
        // Generate ticket ID (SRV-XXXX format)
        generateTicketId() {
            const state = State.get();
            const nextNum = (state.counters?.ticketCounter || 0) + 1;
            State.update({ counters: { ...state.counters, ticketCounter: nextNum } });
            return `SRV-${String(nextNum).padStart(4, '0')}`;
        },
        
        // Format currency
        formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount || 0);
        },
        
        // Format date
        formatDate(date, includeTime = false) {
            const d = new Date(date);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            if (includeTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
            }
            return d.toLocaleDateString('en-US', options);
        },
        
        // Format relative time
        formatRelativeTime(date) {
            const now = new Date();
            const d = new Date(date);
            const diffMs = now - d;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return Utils.formatDate(date);
        },
        
        // Calculate days between dates
        daysBetween(date1, date2 = new Date()) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffTime = Math.abs(d2 - d1);
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        },
        
        // Escape HTML
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        // Debounce function
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },
        
        // Deep clone object
        deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        },
        
        // Calculate storage size
        getStorageSize() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
                }
            }
            return total;
        },
        
        // Format bytes
        formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }
    };

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    const Toast = {
        show(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 toast-enter max-w-sm`;
            toast.innerHTML = `
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${icons[type]}
                </svg>
                <span class="flex-1">${Utils.escapeHtml(message)}</span>
                <button onclick="this.parentElement.remove()" class="text-white/80 hover:text-white">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        },
        
        success(message) { this.show(message, 'success'); },
        error(message) { this.show(message, 'error', 5000); },
        warning(message) { this.show(message, 'warning', 4000); },
        info(message) { this.show(message, 'info'); }
    };

    // ============================================
    // MODAL SYSTEM
    // ============================================
    const Modal = {
        container: null,
        
        init() {
            this.container = document.getElementById('modal-container');
            // Close on backdrop click
            this.container.addEventListener('click', (e) => {
                if (e.target === this.container.firstElementChild) {
                    this.close();
                }
            });
            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !this.container.classList.contains('hidden')) {
                    this.close();
                }
            });
        },
        
        show(templateId) {
            const template = document.getElementById(templateId);
            if (!template) {
                console.error(`Template ${templateId} not found`);
                return;
            }
            this.container.innerHTML = template.innerHTML;
            this.container.classList.remove('hidden');
        },
        
        close() {
            this.container.classList.add('hidden');
            this.container.innerHTML = '';
        }
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    const STORAGE_KEY = 'repairflow_erp_data';
    
    const State = {
        _state: null,
        _listeners: [],
        
        // Default state structure
        getDefaultState() {
            return {
                inventory: [],
                tickets: [],
                transactions: [],
                auditLog: [],
                parts: [],
                users: [
                    { id: 'user-admin', username: 'admin', password: 'admin', name: 'Administrator', role: 'admin', created_at: new Date().toISOString() }
                ],
                locks: [], // { entity_type, entity_id, locked_by, locked_at, expires_at }
                counters: {
                    ticketCounter: 0
                },
                settings: {
                    lastBackup: null,
                    lockTimeoutMinutes: 5
                }
            };
        },
        
        // Initialize state from localStorage
        init() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    this._state = JSON.parse(stored);
                    // Ensure all properties exist
                    const defaults = this.getDefaultState();
                    for (let key in defaults) {
                        if (!(key in this._state)) {
                            this._state[key] = defaults[key];
                        }
                    }
                } else {
                    this._state = this.getDefaultState();
                    this.persist();
                }
            } catch (e) {
                console.error('Failed to load state:', e);
                this._state = this.getDefaultState();
            }
            return this._state;
        },
        
        // Get current state
        get() {
            if (!this._state) this.init();
            return this._state;
        },
        
        // Update state
        update(changes) {
            this._state = { ...this._state, ...changes };
            this.persist();
            this.notifyListeners();
        },
        
        // Persist to localStorage
        persist() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this._state));
                // Broadcast change to other tabs/devices
                if (typeof SyncManager !== 'undefined' && SyncManager.channel) {
                    SyncManager.broadcastChange('data_update');
                }
            } catch (e) {
                console.error('Failed to persist state:', e);
                Toast.error('Failed to save data. Storage may be full.');
            }
        },
        
        // Subscribe to state changes
        subscribe(listener) {
            this._listeners.push(listener);
            return () => {
                this._listeners = this._listeners.filter(l => l !== listener);
            };
        },
        
        // Notify all listeners
        notifyListeners() {
            this._listeners.forEach(listener => listener(this._state));
        },
        
        // Replace entire state (for restore)
        replaceState(newState) {
            this._state = newState;
            this.persist();
            this.notifyListeners();
        },
        
        // Clear all data
        clear() {
            this._state = this.getDefaultState();
            this.persist();
            this.notifyListeners();
        }
    };

    // ============================================
    // AUDIT LOG SERVICE
    // ============================================
    const AuditService = {
        log(entityType, entityId, action, message, details = {}) {
            const state = State.get();
            const entry = {
                id: Utils.generateId('audit'),
                timestamp: new Date().toISOString(),
                entity_type: entityType,
                entity_id: entityId,
                action: action,
                message: message,
                details: details
            };
            
            // Append to audit log (immutable - only add, never modify or delete)
            const auditLog = [...state.auditLog, entry];
            State.update({ auditLog });
            
            return entry;
        },
        
        // Get filtered logs
        getFiltered(filters = {}) {
            const state = State.get();
            let logs = [...state.auditLog].reverse(); // Most recent first
            
            if (filters.entityType) {
                logs = logs.filter(l => l.entity_type === filters.entityType);
            }
            if (filters.action) {
                logs = logs.filter(l => l.action === filters.action);
            }
            if (filters.search) {
                const search = filters.search.toLowerCase();
                logs = logs.filter(l => 
                    l.message.toLowerCase().includes(search) ||
                    l.entity_id?.toLowerCase().includes(search)
                );
            }
            
            return logs;
        },
        
        // Get stats
        getStats() {
            const state = State.get();
            const logs = state.auditLog;
            
            return {
                total: logs.length,
                inventory: logs.filter(l => l.entity_type === 'inventory').length,
                service: logs.filter(l => l.entity_type === 'service').length,
                finance: logs.filter(l => l.entity_type === 'finance').length,
                system: logs.filter(l => l.entity_type === 'system').length
            };
        }
    };

    // ============================================
    // PARTS SERVICE
    // ============================================
    const PartsService = {
        getAll() {
            return State.get().parts || [];
        },
        
        getById(id) {
            return this.getAll().find(p => p.id === id);
        },
        
        add(partData) {
            const state = State.get();
            const part = {
                id: Utils.generateId('part'),
                name: partData.name,
                sku: partData.sku || '',
                category: partData.category || 'general',
                cost_price: parseFloat(partData.cost_price) || 0,
                sell_price: parseFloat(partData.sell_price) || 0,
                stock: parseInt(partData.stock) || 0,
                created_at: new Date().toISOString()
            };
            
            const parts = [...(state.parts || []), part];
            State.update({ parts });
            
            AuditService.log('inventory', part.id, 'create',
                `Added part: ${part.name}`,
                { cost: part.cost_price, sell: part.sell_price }
            );
            
            return part;
        },
        
        update(id, changes) {
            const state = State.get();
            const parts = (state.parts || []).map(p =>
                p.id === id ? { ...p, ...changes } : p
            );
            State.update({ parts });
            return this.getById(id);
        },
        
        delete(id) {
            const state = State.get();
            const parts = (state.parts || []).filter(p => p.id !== id);
            State.update({ parts });
            
            AuditService.log('inventory', id, 'delete', 'Part deleted');
        },
        
        decrementStock(id, qty = 1) {
            const part = this.getById(id);
            if (!part) return null;
            const newStock = Math.max(0, part.stock - qty);
            return this.update(id, { stock: newStock });
        },
        
        getMargin(part) {
            if (!part.sell_price) return 0;
            return ((part.sell_price - part.cost_price) / part.sell_price * 100).toFixed(1);
        }
    };

    // ============================================
    // INVENTORY SERVICE
    // ============================================
    const InventoryService = {
        getAll() {
            return State.get().inventory;
        },
        
        getAvailable() {
            return this.getAll().filter(i => i.status === 'available');
        },
        
        getById(id) {
            return this.getAll().find(i => i.id === id);
        },
        
        async add(itemData) {
            const state = State.get();
            const item = {
                id: Utils.generateId('inv'),
                type: itemData.type,
                brand: itemData.brand,
                model: itemData.model,
                serial: itemData.serial,
                source: itemData.source,
                seller: itemData.seller || '',
                buy: parseFloat(itemData.buy),
                base_sell_price: parseFloat(itemData.base_sell_price),
                current_price: parseFloat(itemData.base_sell_price),
                sell: null,
                status: 'available',
                visual: itemData.visual,
                specs: itemData.specs || '',
                date: new Date().toISOString(),
                warranty_months: 0,
                warranty_expires: null,
                rma_history: [],
                price_override: null
            };
            
            const inventory = [...state.inventory, item];
            State.update({ inventory });
            
            AuditService.log('inventory', item.id, 'create', 
                `Added ${item.brand} ${item.model} to inventory`, 
                { serial: item.serial, buy_price: item.buy }
            );
            
            // Push to server for multi-device sync
            SyncManager.pushToServer('add', item);
            
            return item;
        },
        
        update(id, changes) {
            const state = State.get();
            const inventory = state.inventory.map(item => 
                item.id === id ? { ...item, ...changes } : item
            );
            State.update({ inventory });
            
            return this.getById(id);
        },
        
        sell(id, sellPrice, warrantyMonths, customer = '') {
            const item = this.getById(id);
            if (!item || item.status !== 'available') return null;
            
            const warrantyExpires = warrantyMonths > 0 
                ? new Date(Date.now() + warrantyMonths * 30 * 24 * 60 * 60 * 1000).toISOString()
                : null;
            
            this.update(id, {
                status: 'sold',
                sell: parseFloat(sellPrice),
                warranty_months: warrantyMonths,
                warranty_expires: warrantyExpires,
                sold_date: new Date().toISOString(),
                sold_to: customer
            });
            
            const profit = parseFloat(sellPrice) - item.buy;
            
            // Create transaction
            TransactionService.add({
                type: 'SELL',
                amount: parseFloat(sellPrice),
                profit: profit,
                item_id: id,
                description: `Sold ${item.brand} ${item.model}`
            });
            
            AuditService.log('inventory', id, 'update',
                `Sold ${item.brand} ${item.model} for ${Utils.formatCurrency(sellPrice)}`,
                { profit, warranty_months: warrantyMonths, customer }
            );
            
            // Push sale to server for multi-device sync
            SyncManager.pushToServer('sell', {
                id: id,
                sell: parseFloat(sellPrice),
                sold_to: customer,
                warranty_months: warrantyMonths
            });
            
            return this.getById(id);
        },
        
        overridePrice(id, newPrice, reason) {
            const item = this.getById(id);
            if (!item) return null;
            
            const oldPrice = item.current_price;
            
            this.update(id, {
                current_price: parseFloat(newPrice),
                price_override: {
                    old_price: oldPrice,
                    new_price: parseFloat(newPrice),
                    reason: reason,
                    date: new Date().toISOString()
                }
            });
            
            AuditService.log('inventory', id, 'price_change',
                `Price override: ${Utils.formatCurrency(oldPrice)} → ${Utils.formatCurrency(newPrice)}`,
                { reason, old_price: oldPrice, new_price: newPrice }
            );
            
            return this.getById(id);
        },
        
        addRmaEntry(id, entry) {
            const item = this.getById(id);
            if (!item) return null;
            
            const rmaEntry = {
                id: Utils.generateId('rma'),
                date: new Date().toISOString(),
                ...entry
            };
            
            this.update(id, {
                rma_history: [...(item.rma_history || []), rmaEntry]
            });
            
            AuditService.log('inventory', id, 'update',
                `RMA entry added: ${entry.description}`,
                { rma_entry: rmaEntry }
            );
            
            return this.getById(id);
        },
        
        getAgingCategory(item) {
            const days = Utils.daysBetween(item.date);
            if (days <= 30) return 'fresh';
            if (days <= 60) return 'slow';
            return 'dead';
        },
        
        getAgingStats() {
            const available = this.getAvailable();
            return {
                fresh: available.filter(i => this.getAgingCategory(i) === 'fresh').length,
                slow: available.filter(i => this.getAgingCategory(i) === 'slow').length,
                dead: available.filter(i => this.getAgingCategory(i) === 'dead').length
            };
        },
        
        getTotalValue() {
            return this.getAvailable().reduce((sum, item) => sum + item.current_price, 0);
        }
    };

    // ============================================
    // SERVICE TICKET SERVICE
    // ============================================
    // SERVICE_STATUSES is now loaded from data.json via DataLoader

    const ServiceTicketService = {
        getAll() {
            return State.get().tickets;
        },
        
        getActive() {
            return this.getAll().filter(t => !['ready', 'scrapped'].includes(t.current));
        },
        
        getById(id) {
            return this.getAll().find(t => t.id === id);
        },
        
        create(ticketData) {
            const state = State.get();
            const ticket = {
                id: Utils.generateTicketId(),
                customer: ticketData.customer,
                contact: ticketData.contact,
                device: {
                    type: ticketData.device_type,
                    brand: ticketData.brand,
                    model: ticketData.model,
                    serial: ticketData.serial || ''
                },
                linked_item_id: ticketData.linked_item_id || null,
                is_warranty_claim: ticketData.is_warranty_claim || false,
                current: 'received',
                history: [{
                    status: 'received',
                    timestamp: new Date().toISOString(),
                    note: 'Ticket created'
                }],
                notes: [],
                issue: ticketData.issue,
                condition: ticketData.condition || '',
                created_at: new Date().toISOString()
            };
            
            const tickets = [...state.tickets, ticket];
            State.update({ tickets });
            
            AuditService.log('service', ticket.id, 'create',
                `Service ticket created for ${ticket.device.brand} ${ticket.device.model}`,
                { customer: ticket.customer, is_warranty: ticket.is_warranty_claim }
            );
            
            return ticket;
        },
        
        updateStatus(id, newStatus, note = '') {
            const ticket = this.getById(id);
            if (!ticket) return null;
            
            const statusOrder = SERVICE_STATUSES.map(s => s.key);
            const currentIndex = statusOrder.indexOf(ticket.current);
            const newIndex = statusOrder.indexOf(newStatus);
            
            // Allow forward progression or scrapped from any state
            if (newStatus !== 'scrapped' && newIndex <= currentIndex) {
                return null; // Can't go backwards
            }
            
            const state = State.get();
            const historyEntry = {
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: note || `Status changed to ${SERVICE_STATUSES.find(s => s.key === newStatus)?.label}`
            };
            
            const tickets = state.tickets.map(t => 
                t.id === id 
                    ? { ...t, current: newStatus, history: [...t.history, historyEntry] }
                    : t
            );
            State.update({ tickets });
            
            AuditService.log('service', id, 'status_change',
                `Status: ${ticket.current} → ${newStatus}`,
                { old_status: ticket.current, new_status: newStatus }
            );
            
            // If warranty claim and linked item, add RMA entry
            if (ticket.is_warranty_claim && ticket.linked_item_id && newStatus === 'ready') {
                InventoryService.addRmaEntry(ticket.linked_item_id, {
                    ticket_id: id,
                    description: 'Warranty repair completed',
                    issue: ticket.issue
                });
            }
            
            return this.getById(id);
        },
        
        addNote(id, noteText) {
            const ticket = this.getById(id);
            if (!ticket) return null;
            
            const state = State.get();
            const note = {
                id: Utils.generateId('note'),
                text: noteText,
                timestamp: new Date().toISOString()
            };
            
            const tickets = state.tickets.map(t =>
                t.id === id
                    ? { ...t, notes: [...t.notes, note] }
                    : t
            );
            State.update({ tickets });
            
            return this.getById(id);
        },
        
        getStatusCounts() {
            const tickets = this.getAll();
            const counts = {};
            SERVICE_STATUSES.forEach(s => {
                counts[s.key] = tickets.filter(t => t.current === s.key).length;
            });
            return counts;
        }
    };

    // ============================================
    // TRANSACTION SERVICE
    // ============================================
    const TransactionService = {
        getAll() {
            return State.get().transactions;
        },
        
        add(txData) {
            const state = State.get();
            const transaction = {
                id: Utils.generateId('tx'),
                type: txData.type,
                amount: parseFloat(txData.amount),
                profit: parseFloat(txData.profit || 0),
                date: new Date().toISOString(),
                item_id: txData.item_id || null,
                description: txData.description
            };
            
            const transactions = [...state.transactions, transaction];
            State.update({ transactions });
            
            AuditService.log('finance', transaction.id, 'create',
                `${txData.type}: ${Utils.formatCurrency(txData.amount)}`,
                { type: txData.type, profit: txData.profit }
            );
            
            return transaction;
        },
        
        getByType(type) {
            return this.getAll().filter(t => t.type === type);
        },
        
        getByDateRange(startDate, endDate) {
            return this.getAll().filter(t => {
                const d = new Date(t.date);
                return d >= startDate && d <= endDate;
            });
        },
        
        getStats() {
            const all = this.getAll();
            const sales = all.filter(t => t.type === 'SELL');
            const purchases = all.filter(t => t.type === 'BUY');
            
            const totalRevenue = sales.reduce((sum, t) => sum + t.amount, 0);
            const totalProfit = sales.reduce((sum, t) => sum + t.profit, 0);
            const totalSpent = purchases.reduce((sum, t) => sum + t.amount, 0);
            
            return {
                totalRevenue,
                totalProfit,
                totalSpent,
                margin: totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0,
                salesCount: sales.length,
                purchasesCount: purchases.length,
                avgSalePrice: sales.length > 0 ? totalRevenue / sales.length : 0,
                avgProfit: sales.length > 0 ? totalProfit / sales.length : 0
            };
        },
        
        getRevenueByPeriod() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const yearStart = new Date(now.getFullYear(), 0, 1);
            
            const sales = this.getByType('SELL');
            
            return {
                today: sales.filter(t => new Date(t.date) >= today).reduce((s, t) => s + t.amount, 0),
                week: sales.filter(t => new Date(t.date) >= weekStart).reduce((s, t) => s + t.amount, 0),
                month: sales.filter(t => new Date(t.date) >= monthStart).reduce((s, t) => s + t.amount, 0),
                year: sales.filter(t => new Date(t.date) >= yearStart).reduce((s, t) => s + t.amount, 0)
            };
        }
    };

    // ============================================
    // REPRICING ENGINE
    // Rule-based price decay based on inventory age
    // ============================================
    const RepricingEngine = {
        // Repricing rules configuration
        rules: [
            { minDays: 0, maxDays: 30, discount: 0 },       // Fresh: no discount
            { minDays: 31, maxDays: 45, discount: 5 },      // Slow starting: 5% off
            { minDays: 46, maxDays: 60, discount: 10 },     // Slow: 10% off
            { minDays: 61, maxDays: 90, discount: 15 },     // Dead: 15% off
            { minDays: 91, maxDays: 120, discount: 20 },    // Very dead: 20% off
            { minDays: 121, maxDays: Infinity, discount: 25 } // Critical: 25% off
        ],
        
        // Get discount percentage for given age
        getDiscountForAge(days) {
            const rule = this.rules.find(r => days >= r.minDays && days <= r.maxDays);
            return rule ? rule.discount : 0;
        },
        
        // Calculate current price based on base price and age
        calculateCurrentPrice(item) {
            // If there's a manual override, use it
            if (item.price_override) {
                return item.price_override.new_price;
            }
            
            const days = Utils.daysBetween(item.date);
            const discount = this.getDiscountForAge(days);
            const discountedPrice = item.base_sell_price * (1 - discount / 100);
            
            // Never go below buy price
            return Math.max(discountedPrice, item.buy);
        },
        
        // Get discount info for display
        getDiscountInfo(item) {
            const days = Utils.daysBetween(item.date);
            const discount = this.getDiscountForAge(days);
            const hasOverride = !!item.price_override;
            
            return {
                days,
                discount,
                hasOverride,
                originalPrice: item.base_sell_price,
                calculatedPrice: item.base_sell_price * (1 - discount / 100),
                currentPrice: item.current_price,
                isDiscounted: discount > 0 || hasOverride
            };
        },
        
        // Run repricing on all available inventory
        applyRepricing() {
            const available = InventoryService.getAvailable();
            let updatedCount = 0;
            
            available.forEach(item => {
                // Skip items with manual price override
                if (item.price_override) return;
                
                const newPrice = this.calculateCurrentPrice(item);
                
                if (Math.abs(newPrice - item.current_price) > 0.01) {
                    InventoryService.update(item.id, { current_price: newPrice });
                    updatedCount++;
                }
            });
            
            if (updatedCount > 0) {
                AuditService.log('system', null, 'update',
                    `Auto-repricing applied to ${updatedCount} items`,
                    { updated_count: updatedCount }
                );
            }
            
            return updatedCount;
        }
    };

    // ============================================
    // FORECASTING ENGINE
    // Deterministic, rule-based forecasting (NO ML)
    // ============================================
    const ForecastingEngine = {
        // Calculate average days to sell based on historical data
        getAverageDaysToSell() {
            const soldItems = InventoryService.getAll().filter(i => i.status === 'sold' && i.sold_date);
            
            if (soldItems.length === 0) return 30; // Default assumption
            
            const totalDays = soldItems.reduce((sum, item) => {
                const daysToSell = Utils.daysBetween(item.date, item.sold_date);
                return sum + daysToSell;
            }, 0);
            
            return Math.round(totalDays / soldItems.length);
        },
        
        // Calculate sell-through rate (% of inventory sold per month)
        getSellThroughRate() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Get inventory count 30 days ago (approximation)
            const currentInventory = InventoryService.getAvailable().length;
            const recentSales = TransactionService.getByType('SELL')
                .filter(t => new Date(t.date) >= thirtyDaysAgo).length;
            
            const avgInventory = currentInventory + (recentSales / 2);
            
            if (avgInventory === 0) return 0;
            
            return Math.round((recentSales / avgInventory) * 100);
        },
        
        // Estimate days to clear all inventory
        getDaysToClearInventory() {
            const avgDaysToSell = this.getAverageDaysToSell();
            const currentInventory = InventoryService.getAvailable().length;
            
            if (currentInventory === 0) return 0;
            
            // Simple calculation: avgDaysToSell applies to each item
            // With some parallelism assumption (can sell multiple items at once)
            const parallelism = Math.max(1, Math.ceil(currentInventory / 10));
            
            return Math.round((currentInventory * avgDaysToSell) / parallelism);
        },
        
        // 30-day revenue forecast
        get30DayRevenueForecast() {
            const avgDaysToSell = this.getAverageDaysToSell();
            const available = InventoryService.getAvailable();
            
            if (available.length === 0) return 0;
            
            // Calculate how many items we expect to sell in 30 days
            const expectedSales = Math.ceil(30 / avgDaysToSell * available.length / 10);
            
            // Use average current price
            const avgPrice = available.reduce((sum, i) => sum + i.current_price, 0) / available.length;
            
            return Math.round(expectedSales * avgPrice);
        },
        
        // Calculate risk score for an item
        // LOW: Fresh items, good margin
        // MEDIUM: Aging items or low margin
        // HIGH: Dead stock or negative margin
        calculateRiskScore(item) {
            const days = Utils.daysBetween(item.date);
            const margin = ((item.current_price - item.buy) / item.current_price) * 100;
            
            // Score components (0-100 each, lower is better)
            let ageScore = 0;
            if (days <= 30) ageScore = 0;
            else if (days <= 60) ageScore = 30;
            else if (days <= 90) ageScore = 60;
            else ageScore = 100;
            
            let marginScore = 0;
            if (margin >= 30) marginScore = 0;
            else if (margin >= 20) marginScore = 20;
            else if (margin >= 10) marginScore = 40;
            else if (margin >= 0) marginScore = 70;
            else marginScore = 100;
            
            // Combined score (weighted average)
            const totalScore = (ageScore * 0.6) + (marginScore * 0.4);
            
            if (totalScore <= 30) return 'LOW';
            if (totalScore <= 60) return 'MEDIUM';
            return 'HIGH';
        },
        
        // Get risk distribution
        getRiskDistribution() {
            const available = InventoryService.getAvailable();
            
            return {
                low: available.filter(i => this.calculateRiskScore(i) === 'LOW').length,
                medium: available.filter(i => this.calculateRiskScore(i) === 'MEDIUM').length,
                high: available.filter(i => this.calculateRiskScore(i) === 'HIGH').length
            };
        },
        
        // Estimate days to sell for specific item
        estimateDaysToSell(item) {
            const baseDays = this.getAverageDaysToSell();
            const days = Utils.daysBetween(item.date);
            const risk = this.calculateRiskScore(item);
            
            // Adjust based on current age and risk
            let multiplier = 1;
            if (risk === 'MEDIUM') multiplier = 1.5;
            if (risk === 'HIGH') multiplier = 2.5;
            
            // If item is already old, reduce expected remaining time
            const remainingDays = Math.max(1, baseDays - days);
            
            return Math.round(remainingDays * multiplier);
        },
        
        // Get complete forecast data
        getForecastData() {
            return {
                avgDaysToSell: this.getAverageDaysToSell(),
                sellThroughRate: this.getSellThroughRate(),
                daysToClear: this.getDaysToClearInventory(),
                forecast30Day: this.get30DayRevenueForecast(),
                riskDistribution: this.getRiskDistribution()
            };
        },
        
        // Get per-item forecast
        getItemForecasts() {
            return InventoryService.getAvailable().map(item => {
                const discountInfo = RepricingEngine.getDiscountInfo(item);
                return {
                    item,
                    age: discountInfo.days,
                    discount: discountInfo.discount,
                    hasOverride: discountInfo.hasOverride,
                    risk: this.calculateRiskScore(item),
                    estDaysToSell: this.estimateDaysToSell(item)
                };
            }).sort((a, b) => {
                // Sort by risk (HIGH first) then by age (oldest first)
                const riskOrder = { HIGH: 0, MEDIUM: 1, LOW: 2 };
                if (riskOrder[a.risk] !== riskOrder[b.risk]) {
                    return riskOrder[a.risk] - riskOrder[b.risk];
                }
                return b.age - a.age;
            });
        }
    };

    // ============================================
    // TRADE ENGINE UI
    // ============================================
    const TradeEngine = {
        currentSellItem: null,
        
        handleBuy(event) {
            event.preventDefault();
            
            const grade = document.querySelector('input[name="buy-grade"]:checked')?.value;
            if (!grade) {
                Toast.warning('Please select a visual grade');
                return;
            }
            
            const itemData = {
                type: document.getElementById('buy-type').value,
                brand: document.getElementById('buy-brand').value.trim(),
                model: document.getElementById('buy-model').value.trim(),
                serial: document.getElementById('buy-serial').value.trim(),
                source: document.getElementById('buy-source').value,
                seller: document.getElementById('buy-seller').value.trim(),
                buy: document.getElementById('buy-price').value,
                base_sell_price: document.getElementById('buy-sell-price').value,
                visual: grade,
                specs: document.getElementById('buy-specs').value.trim()
            };
            
            // Validate
            if (!itemData.type || !itemData.brand || !itemData.model || !itemData.serial) {
                Toast.error('Please fill in all required fields');
                return;
            }
            
            // Check for duplicate serial
            const existing = InventoryService.getAll().find(i => i.serial === itemData.serial);
            if (existing) {
                Toast.error('An item with this serial number already exists');
                return;
            }
            
            // Add item
            const item = InventoryService.add(itemData);
            
            // Create BUY transaction
            TransactionService.add({
                type: 'BUY',
                amount: item.buy,
                profit: 0,
                item_id: item.id,
                description: `Purchased ${item.brand} ${item.model}`
            });
            
            Toast.success(`Added ${item.brand} ${item.model} to inventory`);
            
            // Reset form
            document.getElementById('buy-form').reset();
            
            // Refresh UI
            App.refresh();
        },
        
        handleSellSearch(event) {
            event.preventDefault();
            const search = document.getElementById('sell-search').value.trim().toLowerCase();
            TradeUI.renderSellItems(search);
        },
        
        showSellModal(itemId) {
            const item = InventoryService.getById(itemId);
            if (!item) return;
            
            this.currentSellItem = item;
            
            Modal.show('sell-modal-template');
            
            // Populate modal
            document.getElementById('modal-item-name').textContent = `${item.brand} ${item.model}`;
            document.getElementById('modal-item-serial').textContent = item.serial;
            
            const gradeColors = { A: 'bg-green-100 text-green-800', B: 'bg-blue-100 text-blue-800', C: 'bg-yellow-100 text-yellow-800', D: 'bg-red-100 text-red-800' };
            const gradeEl = document.getElementById('modal-item-grade');
            gradeEl.textContent = `Grade ${item.visual}`;
            gradeEl.className = `px-2 py-1 rounded text-xs font-medium ${gradeColors[item.visual]}`;
            
            document.getElementById('modal-sell-price').value = item.current_price.toFixed(2);
            document.getElementById('modal-buy-price').textContent = Utils.formatCurrency(item.buy);
            
            // Update profit calculation on price change
            const sellPriceInput = document.getElementById('modal-sell-price');
            const updateProfit = () => {
                const sellPrice = parseFloat(sellPriceInput.value) || 0;
                const profit = sellPrice - item.buy;
                document.getElementById('modal-sell-price-display').textContent = Utils.formatCurrency(sellPrice);
                document.getElementById('modal-profit').textContent = Utils.formatCurrency(profit);
                document.getElementById('modal-profit').className = profit >= 0 ? 'text-green-600' : 'text-red-600';
            };
            
            sellPriceInput.addEventListener('input', updateProfit);
            updateProfit();
        },
        
        confirmSale() {
            if (!this.currentSellItem) return;
            
            const sellPrice = parseFloat(document.getElementById('modal-sell-price').value);
            const warranty = parseInt(document.getElementById('modal-warranty').value);
            const customer = document.getElementById('modal-customer').value.trim();
            
            if (sellPrice <= 0) {
                Toast.error('Please enter a valid sell price');
                return;
            }
            
            InventoryService.sell(this.currentSellItem.id, sellPrice, warranty, customer);
            
            Toast.success(`Sold ${this.currentSellItem.brand} ${this.currentSellItem.model}`);
            
            Modal.close();
            this.currentSellItem = null;
            App.refresh();
        }
    };

    // ============================================
    // DASHBOARD UI
    // ============================================
    const DashboardUI = {
        render() {
            const stats = TransactionService.getStats();
            const aging = InventoryService.getAgingStats();
            const available = InventoryService.getAvailable();
            
            // KPIs
            document.getElementById('kpi-revenue').textContent = Utils.formatCurrency(stats.totalRevenue);
            document.getElementById('kpi-profit').textContent = Utils.formatCurrency(stats.totalProfit);
            document.getElementById('kpi-profit-margin').textContent = `${stats.margin.toFixed(1)}%`;
            document.getElementById('kpi-inventory-value').textContent = Utils.formatCurrency(InventoryService.getTotalValue());
            document.getElementById('kpi-inventory-items').textContent = `${available.length} items`;
            document.getElementById('kpi-dead-stock').textContent = aging.dead;
            document.getElementById('kpi-dead-alert').style.display = aging.dead > 0 ? 'inline' : 'none';
            
            // Aging
            document.getElementById('aging-fresh').textContent = aging.fresh;
            document.getElementById('aging-slow').textContent = aging.slow;
            document.getElementById('aging-dead').textContent = aging.dead;
            
            // Active tickets
            const activeTickets = ServiceTicketService.getActive().slice(0, 5);
            const ticketsEl = document.getElementById('dashboard-tickets');
            if (activeTickets.length === 0) {
                ticketsEl.innerHTML = '<p class="text-slate-400 text-center py-8">No active tickets</p>';
            } else {
                ticketsEl.innerHTML = activeTickets.map(t => {
                    const status = SERVICE_STATUSES.find(s => s.key === t.current);
                    return `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div>
                                <p class="font-medium text-slate-800">${t.id}</p>
                                <p class="text-sm text-slate-500">${t.device.brand} ${t.device.model}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-${status.color}-100 text-${status.color}-700">${status.label}</span>
                        </div>
                    `;
                }).join('');
            }
            
            // Recent transactions
            const recentTx = TransactionService.getAll().slice(-5).reverse();
            const txEl = document.getElementById('dashboard-transactions');
            if (recentTx.length === 0) {
                txEl.innerHTML = '<p class="text-slate-400 text-center py-8">No transactions yet</p>';
            } else {
                txEl.innerHTML = recentTx.map(t => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <div>
                            <p class="font-medium text-slate-800">${t.description}</p>
                            <p class="text-sm text-slate-500">${Utils.formatRelativeTime(t.date)}</p>
                        </div>
                        <span class="font-semibold ${t.type === 'SELL' ? 'text-green-600' : 'text-blue-600'}">${t.type === 'SELL' ? '+' : '-'}${Utils.formatCurrency(t.amount)}</span>
                    </div>
                `).join('');
            }
            
            // Recent repair activity - tickets with recent notes or status changes
            this.renderRecentRepairActivity();
        },
        
        renderRecentRepairActivity() {
            const tbody = document.getElementById('dashboard-repair-activity');
            const tickets = ServiceTicketService.getAll();
            
            // Get tickets with their last activity timestamp
            const ticketsWithActivity = tickets.map(t => {
                // Find the latest activity (note or status change)
                let lastActivity = new Date(t.created_at);
                let activityType = 'Created';
                
                // Check history for status changes
                if (t.history && t.history.length > 0) {
                    const lastHistoryItem = t.history[t.history.length - 1];
                    const historyDate = new Date(lastHistoryItem.timestamp);
                    if (historyDate > lastActivity) {
                        lastActivity = historyDate;
                        activityType = 'Status: ' + (SERVICE_STATUSES.find(s => s.key === lastHistoryItem.status)?.label || lastHistoryItem.status);
                    }
                }
                
                // Check notes
                if (t.notes && t.notes.length > 0) {
                    const lastNote = t.notes[t.notes.length - 1];
                    const noteDate = new Date(lastNote.timestamp);
                    if (noteDate > lastActivity) {
                        lastActivity = noteDate;
                        activityType = 'Note added';
                    }
                }
                
                return { ...t, lastActivity, activityType };
            });
            
            // Sort by last activity (most recent first)
            ticketsWithActivity.sort((a, b) => b.lastActivity - a.lastActivity);
            
            // Take top 10
            const recentTickets = ticketsWithActivity.slice(0, 10);
            
            if (recentTickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-400">No recent activity</td></tr>';
                return;
            }
            
            tbody.innerHTML = recentTickets.map(t => {
                const status = SERVICE_STATUSES.find(s => s.key === t.current);
                return `
                    <tr class="hover:bg-slate-50 cursor-pointer" onclick="App.navigate('service'); setTimeout(() => ServiceUI.showTicketDetails('${t.id}'), 100)">
                        <td class="px-4 py-3">
                            <span class="font-medium text-blue-600">${t.id}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-medium text-slate-800">${t.device.brand} ${t.device.model}</span>
                        </td>
                        <td class="px-4 py-3 text-slate-600">${t.customer}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-${status.color}-100 text-${status.color}-700">${status.label}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-500">
                            <div>${Utils.formatRelativeTime(t.lastActivity)}</div>
                            <div class="text-xs text-slate-400">${t.activityType}</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    };

    // ============================================
    // INVENTORY UI
    // ============================================
    const InventoryUI = {
        currentOverrideItem: null,
        
        render() {
            this.applyFilters();
            document.getElementById('inventory-count').textContent = InventoryService.getAvailable().length;
        },
        
        applyFilters() {
            const status = document.getElementById('inventory-filter-status').value;
            const aging = document.getElementById('inventory-filter-aging').value;
            const search = document.getElementById('inventory-search').value.toLowerCase();
            
            let items = InventoryService.getAll();
            
            if (status) items = items.filter(i => i.status === status);
            if (aging) items = items.filter(i => InventoryService.getAgingCategory(i) === aging);
            if (search) items = items.filter(i => 
                i.brand.toLowerCase().includes(search) ||
                i.model.toLowerCase().includes(search) ||
                i.serial.toLowerCase().includes(search)
            );
            
            this.renderTable(items);
        },
        
        renderTable(items) {
            const tbody = document.getElementById('inventory-table-body');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-12 text-slate-400">No inventory items</td></tr>';
                return;
            }
            
            tbody.innerHTML = items.map(item => {
                const days = Utils.daysBetween(item.date);
                const agingCat = InventoryService.getAgingCategory(item);
                const discountInfo = RepricingEngine.getDiscountInfo(item);
                
                const agingColors = { fresh: 'green', slow: 'yellow', dead: 'red' };
                const gradeColors = { A: 'green', B: 'blue', C: 'yellow', D: 'red' };
                const statusColors = { available: 'green', reserved: 'yellow', sold: 'slate' };
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-slate-800">${item.brand} ${item.model}</p>
                                <p class="text-sm text-slate-500">${item.type}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 font-mono text-sm text-slate-600">${item.serial}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${gradeColors[item.visual]}-100 text-${gradeColors[item.visual]}-700">Grade ${item.visual}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${agingColors[agingCat]}-100 text-${agingColors[agingCat]}-700">${days}d</span>
                        </td>
                        <td class="px-6 py-4 text-slate-600">${Utils.formatCurrency(item.buy)}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-slate-800">${Utils.formatCurrency(item.current_price)}</span>
                                ${discountInfo.isDiscounted ? `<span class="text-xs text-orange-500">-${discountInfo.discount}%</span>` : ''}
                                ${discountInfo.hasOverride ? '<span class="text-xs text-purple-500">Manual</span>' : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${statusColors[item.status]}-100 text-${statusColors[item.status]}-700">${item.status}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                ${item.status === 'available' ? `
                                    <button onclick="InventoryUI.showPriceOverride('${item.id}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium">Price</button>
                                    <button onclick="TradeEngine.showSellModal('${item.id}')" class="text-green-600 hover:text-green-800 text-sm font-medium">Sell</button>
                                ` : ''}
                                <button onclick="InventoryUI.showDetails('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        },
        
        showPriceOverride(itemId) {
            const item = InventoryService.getById(itemId);
            if (!item) return;
            
            this.currentOverrideItem = item;
            Modal.show('price-override-modal-template');
            
            document.getElementById('override-item-name').textContent = `${item.brand} ${item.model}`;
            document.getElementById('override-item-serial').textContent = item.serial;
            document.getElementById('override-current-price').textContent = Utils.formatCurrency(item.current_price);
            document.getElementById('override-new-price').value = item.current_price.toFixed(2);
        },
        
        confirmPriceOverride() {
            if (!this.currentOverrideItem) return;
            
            const newPrice = parseFloat(document.getElementById('override-new-price').value);
            const reason = document.getElementById('override-reason').value.trim();
            
            if (!reason) {
                Toast.warning('Please provide a reason for the price change');
                return;
            }
            
            InventoryService.overridePrice(this.currentOverrideItem.id, newPrice, reason);
            Toast.success('Price updated successfully');
            
            Modal.close();
            this.currentOverrideItem = null;
            App.refresh();
        },
        
        showDetails(itemId) {
            const item = InventoryService.getById(itemId);
            if (!item) return;
            
            Modal.show('item-details-modal-template');
            
            const content = document.getElementById('item-details-content');
            const days = Utils.daysBetween(item.date);
            
            content.innerHTML = `
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 rounded-lg p-4">
                            <h4 class="font-semibold text-slate-800 mb-3">Basic Information</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-slate-500">Type:</span><span class="font-medium">${item.type}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Brand:</span><span class="font-medium">${item.brand}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Model:</span><span class="font-medium">${item.model}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Serial:</span><span class="font-medium font-mono">${item.serial}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Grade:</span><span class="font-medium">${item.visual}</span></div>
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-4">
                            <h4 class="font-semibold text-slate-800 mb-3">Acquisition</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-slate-500">Source:</span><span class="font-medium">${item.source}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Seller:</span><span class="font-medium">${item.seller || 'N/A'}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Date Added:</span><span class="font-medium">${Utils.formatDate(item.date)}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Age:</span><span class="font-medium">${days} days</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-slate-50 rounded-lg p-4">
                            <h4 class="font-semibold text-slate-800 mb-3">Pricing</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-slate-500">Buy Price:</span><span class="font-medium">${Utils.formatCurrency(item.buy)}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Base Price:</span><span class="font-medium">${Utils.formatCurrency(item.base_sell_price)}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Current Price:</span><span class="font-medium text-lg">${Utils.formatCurrency(item.current_price)}</span></div>
                                ${item.sell ? `<div class="flex justify-between"><span class="text-slate-500">Sold For:</span><span class="font-medium text-green-600">${Utils.formatCurrency(item.sell)}</span></div>` : ''}
                            </div>
                        </div>
                        ${item.status === 'sold' ? `
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-3">Sale Information</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-green-600">Sold Date:</span><span class="font-medium">${Utils.formatDate(item.sold_date)}</span></div>
                                <div class="flex justify-between"><span class="text-green-600">Customer:</span><span class="font-medium">${item.sold_to || 'N/A'}</span></div>
                                <div class="flex justify-between"><span class="text-green-600">Warranty:</span><span class="font-medium">${item.warranty_months} months</span></div>
                                <div class="flex justify-between"><span class="text-green-600">Profit:</span><span class="font-medium">${Utils.formatCurrency(item.sell - item.buy)}</span></div>
                            </div>
                        </div>
                        ` : ''}
                        ${item.rma_history && item.rma_history.length > 0 ? `
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-800 mb-3">RMA History</h4>
                            <div class="space-y-2">
                                ${item.rma_history.map(rma => `
                                    <div class="text-sm p-2 bg-white rounded">
                                        <p class="text-slate-600">${rma.description}</p>
                                        <p class="text-xs text-slate-400 mt-1">${Utils.formatDate(rma.date)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ${item.specs ? `<div class="mt-4 bg-slate-50 rounded-lg p-4"><h4 class="font-semibold text-slate-800 mb-2">Specifications</h4><p class="text-sm text-slate-600">${item.specs}</p></div>` : ''}
            `;
        }
    };

    // ============================================
    // TRADE UI
    // ============================================
    const TradeUI = {
        render() {
            this.renderSellItems('');
            this.renderRecentTrades();
        },
        
        renderSellItems(search) {
            let items = InventoryService.getAvailable();
            
            if (search) {
                items = items.filter(i =>
                    i.serial.toLowerCase().includes(search) ||
                    i.model.toLowerCase().includes(search) ||
                    i.brand.toLowerCase().includes(search)
                );
            }
            
            const container = document.getElementById('sell-items-list');
            
            if (items.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center py-8">No items available for sale</p>';
                return;
            }
            
            container.innerHTML = items.slice(0, 10).map(item => {
                const gradeColors = { A: 'green', B: 'blue', C: 'yellow', D: 'red' };
                return `
                    <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:border-blue-300 transition-all">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-slate-800">${item.brand} ${item.model}</p>
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-${gradeColors[item.visual]}-100 text-${gradeColors[item.visual]}-700">${item.visual}</span>
                            </div>
                            <p class="text-sm text-slate-500 font-mono">${item.serial}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-slate-800">${Utils.formatCurrency(item.current_price)}</p>
                            <button onclick="TradeEngine.showSellModal('${item.id}')" class="mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium">Sell →</button>
                        </div>
                    </div>
                `;
            }).join('');
        },
        
        renderRecentTrades() {
            const trades = TransactionService.getAll().slice(-10).reverse();
            const container = document.getElementById('recent-trades');
            
            if (trades.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center py-8">No recent trades</p>';
                return;
            }
            
            container.innerHTML = trades.map(t => `
                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'SELL' ? 'bg-green-100' : 'bg-blue-100'}">
                            <svg class="w-5 h-5 ${t.type === 'SELL' ? 'text-green-600' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${t.type === 'SELL' 
                                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>'
                                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>'}
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-slate-800">${t.description}</p>
                            <p class="text-sm text-slate-500">${Utils.formatDate(t.date, true)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold ${t.type === 'SELL' ? 'text-green-600' : 'text-blue-600'}">${t.type === 'SELL' ? '+' : '-'}${Utils.formatCurrency(t.amount)}</p>
                        ${t.profit ? `<p class="text-sm text-slate-500">Profit: ${Utils.formatCurrency(t.profit)}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }
    };

    // ============================================
    // SERVICE UI
    // ============================================
    const ServiceUI = {
        currentTicket: null,
        
        render() {
            this.updateStatusCounts();
            this.applyFilters();
            document.getElementById('service-count').textContent = ServiceTicketService.getActive().length;
        },
        
        updateStatusCounts() {
            const counts = ServiceTicketService.getStatusCounts();
            document.getElementById('status-received').textContent = counts.received || 0;
            document.getElementById('status-diagnostics').textContent = counts.diagnostics || 0;
            document.getElementById('status-waiting').textContent = counts.waiting_parts || 0;
            document.getElementById('status-repairing').textContent = counts.repairing || 0;
            document.getElementById('status-testing').textContent = counts.testing || 0;
            document.getElementById('status-ready').textContent = counts.ready || 0;
            document.getElementById('status-scrapped').textContent = counts.scrapped || 0;
        },
        
        applyFilters() {
            const status = document.getElementById('service-filter-status').value;
            const warranty = document.getElementById('service-filter-warranty').value;
            const search = document.getElementById('service-search').value.toLowerCase();
            
            let tickets = ServiceTicketService.getAll();
            
            if (status) tickets = tickets.filter(t => t.current === status);
            if (warranty === 'warranty') tickets = tickets.filter(t => t.is_warranty_claim);
            if (warranty === 'regular') tickets = tickets.filter(t => !t.is_warranty_claim);
            if (search) tickets = tickets.filter(t => 
                t.id.toLowerCase().includes(search) ||
                t.customer.toLowerCase().includes(search) ||
                t.device.brand.toLowerCase().includes(search) ||
                t.device.model.toLowerCase().includes(search)
            );
            
            this.renderTicketList(tickets);
        },
        
        renderTicketList(tickets) {
            const container = document.getElementById('service-tickets-list');
            
            if (tickets.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-slate-400">No service tickets</div>';
                return;
            }
            
            container.innerHTML = tickets.map(t => {
                const status = SERVICE_STATUSES.find(s => s.key === t.current);
                return `
                    <div class="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer" onclick="ServiceUI.showTicketDetails('${t.id}')">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center">
                                <span class="text-lg font-bold text-slate-600">${t.id.split('-')[1]}</span>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-medium text-slate-800">${t.device.brand} ${t.device.model}</p>
                                    ${t.is_warranty_claim ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700">Warranty</span>' : ''}
                                </div>
                                <p class="text-sm text-slate-500">${t.customer} • ${Utils.formatRelativeTime(t.created_at)}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-${status.color}-100 text-${status.color}-700">${status.label}</span>
                    </div>
                `;
            }).join('');
        },
        
        showNewTicketModal() {
            Modal.show('new-ticket-modal-template');
            const linkedSelect = document.getElementById('ticket-linked-item');
            const soldItems = InventoryService.getAll().filter(i => i.status === 'sold' && i.warranty_expires);
            linkedSelect.innerHTML = '<option value="">No linked item</option>' + 
                soldItems.map(i => `<option value="${i.id}">${i.brand} ${i.model} (${i.serial})</option>`).join('');
        },
        
        handleCreateTicket(event) {
            event.preventDefault();
            const ticketData = {
                customer: document.getElementById('ticket-customer').value.trim(),
                contact: document.getElementById('ticket-contact').value.trim(),
                device_type: document.getElementById('ticket-device-type').value,
                brand: document.getElementById('ticket-brand').value.trim(),
                model: document.getElementById('ticket-model').value.trim(),
                serial: document.getElementById('ticket-serial').value.trim(),
                linked_item_id: document.getElementById('ticket-linked-item').value || null,
                is_warranty_claim: document.getElementById('ticket-warranty').checked,
                issue: document.getElementById('ticket-issue').value.trim(),
                condition: document.getElementById('ticket-condition').value.trim()
            };
            
            const ticket = ServiceTicketService.create(ticketData);
            Toast.success(`Ticket ${ticket.id} created successfully`);
            Modal.close();
            App.refresh();
        },
        
        showTicketDetails(ticketId) {
            const ticket = ServiceTicketService.getById(ticketId);
            if (!ticket) return;
            
            this.currentTicket = ticket;
            Modal.show('ticket-details-modal-template');
            
            document.getElementById('ticket-modal-id').textContent = ticket.id;
            document.getElementById('ticket-modal-device').textContent = `${ticket.device.brand} ${ticket.device.model}`;
            document.getElementById('ticket-modal-customer').textContent = ticket.customer;
            document.getElementById('ticket-modal-contact').textContent = ticket.contact;
            document.getElementById('ticket-modal-serial').textContent = ticket.device.serial || 'N/A';
            document.getElementById('ticket-modal-warranty').textContent = ticket.is_warranty_claim ? 'Yes' : 'No';
            document.getElementById('ticket-modal-linked').textContent = ticket.linked_item_id ? 'Yes' : 'No';
            document.getElementById('ticket-modal-issue').textContent = ticket.issue;
            
            // Timeline
            const timeline = document.getElementById('ticket-modal-timeline');
            timeline.innerHTML = ticket.history.map(h => {
                const status = SERVICE_STATUSES.find(s => s.key === h.status);
                return `
                    <div class="relative pl-8 timeline-item">
                        <div class="absolute left-0 w-8 h-8 bg-${status.color}-100 rounded-full flex items-center justify-center">
                            <div class="w-3 h-3 bg-${status.color}-500 rounded-full"></div>
                        </div>
                        <div class="pb-4">
                            <p class="font-medium text-slate-800">${status.label}</p>
                            <p class="text-sm text-slate-500">${Utils.formatDate(h.timestamp, true)}</p>
                            ${h.note ? `<p class="text-sm text-slate-600 mt-1">${h.note}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Notes
            const notes = document.getElementById('ticket-modal-notes');
            notes.innerHTML = ticket.notes.length > 0 
                ? ticket.notes.map(n => `<div class="text-sm p-2 bg-slate-50 rounded"><p>${n.text}</p><p class="text-xs text-slate-400 mt-1">${Utils.formatRelativeTime(n.timestamp)}</p></div>`).join('')
                : '<p class="text-sm text-slate-400">No notes yet</p>';
            
            // Status buttons
            const statusBtns = document.getElementById('status-buttons');
            const currentIndex = SERVICE_STATUSES.findIndex(s => s.key === ticket.current);
            statusBtns.innerHTML = SERVICE_STATUSES.map((s, i) => {
                const isNext = i === currentIndex + 1;
                const isScrapped = s.key === 'scrapped';
                const disabled = !isNext && !isScrapped;
                return `<button onclick="ServiceUI.updateStatus('${s.key}')" ${disabled ? 'disabled' : ''} class="py-2 px-3 rounded-lg text-sm font-medium transition-all ${disabled ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : isNext ? 'bg-blue-600 text-white hover:bg-blue-700' : isScrapped ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-slate-100 text-slate-600'}">${s.label}</button>`;
            }).join('');
        },
        
        updateStatus(newStatus) {
            if (!this.currentTicket) return;
            const result = ServiceTicketService.updateStatus(this.currentTicket.id, newStatus);
            if (result) {
                Toast.success(`Status updated to ${SERVICE_STATUSES.find(s => s.key === newStatus)?.label}`);
                this.showTicketDetails(this.currentTicket.id);
                this.render();
            }
        },
        
        addNote() {
            if (!this.currentTicket) return;
            const noteText = document.getElementById('ticket-new-note').value.trim();
            if (!noteText) return;
            ServiceTicketService.addNote(this.currentTicket.id, noteText);
            document.getElementById('ticket-new-note').value = '';
            this.showTicketDetails(this.currentTicket.id);
        },
        
        printIntakeProtocol() {
            if (!this.currentTicket) return;
            const t = this.currentTicket;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html><head><title>Intake Protocol - ${t.id}</title><style>body{font-family:Arial,sans-serif;max-width:600px;margin:40px auto;padding:20px}h1,h2{text-align:center}table{width:100%;border-collapse:collapse;margin:20px 0}td{padding:8px;border-bottom:1px solid #ccc}.sig{margin-top:60px;display:flex;justify-content:space-between}.sig div{width:45%;border-top:1px solid #000;padding-top:5px;text-align:center}</style></head><body><h1>RepairFlow ERP</h1><h2>Service Intake Protocol</h2><table><tr><td><strong>Ticket ID:</strong></td><td>${t.id}</td></tr><tr><td><strong>Date:</strong></td><td>${Utils.formatDate(t.created_at, true)}</td></tr><tr><td><strong>Customer:</strong></td><td>${t.customer}</td></tr><tr><td><strong>Contact:</strong></td><td>${t.contact}</td></tr><tr><td><strong>Device:</strong></td><td>${t.device.brand} ${t.device.model}</td></tr><tr><td><strong>Serial/IMEI:</strong></td><td>${t.device.serial || 'N/A'}</td></tr><tr><td><strong>Warranty Claim:</strong></td><td>${t.is_warranty_claim ? 'Yes' : 'No'}</td></tr></table><h3>Issue Description</h3><p>${t.issue}</p><h3>Visual Condition at Intake</h3><p>${t.condition || 'Not specified'}</p><div class="sig"><div>Customer Signature</div><div>Technician Signature</div></div></body></html>`);
            printWindow.document.close();
            printWindow.print();
        },
        
        showPartsModal() {
            Modal.show('parts-modal-template');
            this.renderPartsTable();
        },
        
        handleAddPart(event) {
            event.preventDefault();
            const partData = {
                name: document.getElementById('part-name').value.trim(),
                sku: document.getElementById('part-sku').value.trim(),
                category: document.getElementById('part-category').value,
                cost_price: document.getElementById('part-cost').value,
                sell_price: document.getElementById('part-sell').value,
                stock: document.getElementById('part-stock').value || 0
            };
            PartsService.add(partData);
            Toast.success(`Part "${partData.name}" added to catalog`);
            document.getElementById('add-part-form').reset();
            this.renderPartsTable();
        },
        
        renderPartsTable() {
            const parts = PartsService.getAll();
            const tbody = document.getElementById('parts-table-body');
            if (parts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-400">No parts in catalog</td></tr>';
                return;
            }
            const catColors = { screen: 'blue', battery: 'green', camera: 'purple', speaker: 'orange', connector: 'yellow', button: 'pink', general: 'slate', other: 'gray' };
            tbody.innerHTML = parts.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 font-medium text-slate-800">${p.name}</td>
                    <td class="px-4 py-3 text-sm text-slate-500 font-mono">${p.sku || '-'}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-medium bg-${catColors[p.category] || 'slate'}-100 text-${catColors[p.category] || 'slate'}-700">${p.category}</span></td>
                    <td class="px-4 py-3 text-right text-sm text-slate-600">${Utils.formatCurrency(p.cost_price)}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium text-slate-800">${Utils.formatCurrency(p.sell_price)}</td>
                    <td class="px-4 py-3 text-right text-sm text-green-600">${PartsService.getMargin(p)}%</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded text-xs font-medium ${p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${p.stock}</span></td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="ServiceUI.deletePart('${p.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                    </td>
                </tr>
            `).join('');
        },
        
        deletePart(partId) {
            if (confirm('Are you sure you want to delete this part?')) {
                PartsService.delete(partId);
                Toast.success('Part deleted');
                this.renderPartsTable();
            }
        }
    };

    // ============================================
    // TRACKING UI (Public)
    // ============================================
    const TrackingUI = {
        handleSearch(event) {
            event.preventDefault();
            const ticketId = document.getElementById('tracking-ticket-id').value.trim().toUpperCase();
            const ticket = ServiceTicketService.getById(ticketId);
            
            document.getElementById('tracking-result').classList.add('hidden');
            document.getElementById('tracking-not-found').classList.add('hidden');
            
            if (!ticket) {
                document.getElementById('tracking-not-found').classList.remove('hidden');
                return;
            }
            
            document.getElementById('tracking-result').classList.remove('hidden');
            document.getElementById('tracking-device').textContent = `${ticket.device.brand} ${ticket.device.model}`;
            document.getElementById('tracking-id').textContent = ticket.id;
            
            const status = SERVICE_STATUSES.find(s => s.key === ticket.current);
            const badge = document.getElementById('tracking-status-badge');
            badge.textContent = status.label;
            badge.className = `px-4 py-2 rounded-full text-sm font-medium bg-${status.color}-100 text-${status.color}-700`;
            
            const descriptions = {
                received: 'Your device has been received and is awaiting diagnostics.',
                diagnostics: 'Our technicians are diagnosing the issue with your device.',
                waiting_parts: 'We are waiting for replacement parts to arrive.',
                repairing: 'Your device is currently being repaired.',
                testing: 'The repair is complete and we are testing your device.',
                ready: 'Your device is ready for pickup!',
                scrapped: 'Unfortunately, the device could not be repaired.'
            };
            document.getElementById('tracking-status-description').textContent = descriptions[ticket.current];
            
            const timeline = document.getElementById('tracking-timeline');
            timeline.innerHTML = ticket.history.map(h => {
                const s = SERVICE_STATUSES.find(st => st.key === h.status);
                return `<div class="flex items-start gap-4"><div class="w-3 h-3 bg-${s.color}-500 rounded-full mt-1.5"></div><div><p class="font-medium text-slate-800">${s.label}</p><p class="text-sm text-slate-500">${Utils.formatDate(h.timestamp, true)}</p></div></div>`;
            }).join('');
        }
    };

    // ============================================
    // FINANCE UI
    // ============================================
    const FinanceUI = {
        render() {
            const stats = TransactionService.getStats();
            const period = TransactionService.getRevenueByPeriod();
            
            document.getElementById('finance-total-revenue').textContent = Utils.formatCurrency(stats.totalRevenue);
            document.getElementById('finance-total-profit').textContent = Utils.formatCurrency(stats.totalProfit);
            document.getElementById('finance-margin').textContent = `${stats.margin.toFixed(1)}%`;
            document.getElementById('finance-inventory-value').textContent = Utils.formatCurrency(InventoryService.getTotalValue());
            document.getElementById('finance-today').textContent = Utils.formatCurrency(period.today);
            document.getElementById('finance-week').textContent = Utils.formatCurrency(period.week);
            document.getElementById('finance-month').textContent = Utils.formatCurrency(period.month);
            document.getElementById('finance-year').textContent = Utils.formatCurrency(period.year);
            document.getElementById('finance-items-sold').textContent = stats.salesCount;
            document.getElementById('finance-items-bought').textContent = stats.purchasesCount;
            document.getElementById('finance-avg-sale').textContent = Utils.formatCurrency(stats.avgSalePrice);
            document.getElementById('finance-avg-profit').textContent = Utils.formatCurrency(stats.avgProfit);
            
            this.applyFilters();
        },
        
        applyFilters() {
            const type = document.getElementById('ledger-filter-type').value;
            let transactions = TransactionService.getAll();
            if (type) transactions = transactions.filter(t => t.type === type);
            this.renderLedger(transactions.slice().reverse());
        },
        
        renderLedger(transactions) {
            const tbody = document.getElementById('ledger-table-body');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-400">No transactions yet</td></tr>';
                return;
            }
            tbody.innerHTML = transactions.map(t => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 text-sm text-slate-600">${Utils.formatDate(t.date, true)}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-medium ${t.type === 'SELL' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${t.type}</span></td>
                    <td class="px-4 py-3 text-sm text-slate-800">${t.description}</td>
                    <td class="px-4 py-3 text-right font-medium ${t.type === 'SELL' ? 'text-green-600' : 'text-blue-600'}">${t.type === 'SELL' ? '+' : '-'}${Utils.formatCurrency(t.amount)}</td>
                    <td class="px-4 py-3 text-right text-sm ${t.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${t.profit ? Utils.formatCurrency(t.profit) : '-'}</td>
                </tr>
            `).join('');
        }
    };

    // ============================================
    // FORECAST UI
    // ============================================
    const ForecastUI = {
        render() {
            const data = ForecastingEngine.getForecastData();
            document.getElementById('forecast-avg-days').textContent = data.avgDaysToSell;
            document.getElementById('forecast-sell-through').textContent = `${data.sellThroughRate}%`;
            document.getElementById('forecast-days-clear').textContent = data.daysToClear;
            document.getElementById('forecast-30day').textContent = Utils.formatCurrency(data.forecast30Day);
            document.getElementById('risk-low').textContent = data.riskDistribution.low;
            document.getElementById('risk-medium').textContent = data.riskDistribution.medium;
            document.getElementById('risk-high').textContent = data.riskDistribution.high;
            this.renderForecastTable();
        },
        
        renderForecastTable() {
            const forecasts = ForecastingEngine.getItemForecasts();
            const tbody = document.getElementById('forecast-table-body');
            if (forecasts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">No inventory items</td></tr>';
                return;
            }
            tbody.innerHTML = forecasts.map(f => {
                const riskColors = { LOW: 'green', MEDIUM: 'yellow', HIGH: 'red' };
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3"><p class="font-medium text-slate-800">${f.item.brand} ${f.item.model}</p><p class="text-xs text-slate-500">${f.item.serial}</p></td>
                        <td class="px-4 py-3 text-sm text-slate-600">${f.age} days</td>
                        <td class="px-4 py-3 text-sm font-medium text-slate-800">${Utils.formatCurrency(f.item.current_price)}</td>
                        <td class="px-4 py-3 text-sm">${f.discount > 0 ? `<span class="text-orange-600">-${f.discount}%</span>` : '-'}${f.hasOverride ? ' <span class="text-purple-500">(Manual)</span>' : ''}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-medium bg-${riskColors[f.risk]}-100 text-${riskColors[f.risk]}-700">${f.risk}</span></td>
                        <td class="px-4 py-3 text-sm text-slate-600">~${f.estDaysToSell} days</td>
                    </tr>`;
            }).join('');
        }
    };

    // ============================================
    // AUDIT UI
    // ============================================
    const AuditUI = {
        render() {
            const stats = AuditService.getStats();
            document.getElementById('audit-total').textContent = stats.total;
            document.getElementById('audit-inventory').textContent = stats.inventory;
            document.getElementById('audit-service').textContent = stats.service;
            document.getElementById('audit-finance').textContent = stats.finance;
            this.applyFilters();
        },
        
        applyFilters() {
            const type = document.getElementById('audit-filter-type').value;
            const action = document.getElementById('audit-filter-action').value;
            const search = document.getElementById('audit-search').value;
            const logs = AuditService.getFiltered({ entityType: type, action, search });
            this.renderTimeline(logs);
        },
        
        renderTimeline(logs) {
            const container = document.getElementById('audit-timeline');
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-slate-400">No audit events recorded</div>';
                return;
            }
            const typeColors = { inventory: 'blue', service: 'purple', finance: 'green', system: 'slate' };
            container.innerHTML = logs.slice(0, 100).map(l => `
                <div class="flex items-start gap-4 p-3 hover:bg-slate-50 rounded-lg">
                    <div class="w-10 h-10 bg-${typeColors[l.entity_type] || 'slate'}-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-xs font-medium text-${typeColors[l.entity_type] || 'slate'}-600">${l.entity_type?.substring(0, 3).toUpperCase()}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-800">${l.message}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-slate-400">${Utils.formatDate(l.timestamp, true)}</span>
                            <span class="px-1.5 py-0.5 rounded text-xs bg-slate-100 text-slate-600">${l.action}</span>
                            ${l.entity_id ? `<span class="text-xs text-slate-400 font-mono">${l.entity_id}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
    };

    // ============================================
    // BACKUP UI
    // ============================================
    const BackupUI = {
        pendingBackupData: null,
        
        render() {
            const state = State.get();
            document.getElementById('backup-inventory-count').textContent = state.inventory.length;
            document.getElementById('backup-ticket-count').textContent = state.tickets.length;
            document.getElementById('backup-transaction-count').textContent = state.transactions.length;
            document.getElementById('backup-audit-count').textContent = state.auditLog.length;
            document.getElementById('storage-used').textContent = Utils.formatBytes(Utils.getStorageSize());
            document.getElementById('last-backup').textContent = state.settings.lastBackup ? Utils.formatDate(state.settings.lastBackup, true) : 'Never';
        },
        
        createBackup() {
            const state = State.get();
            const backup = {
                version: '1.0.0',
                created_at: new Date().toISOString(),
                data: { inventory: state.inventory, tickets: state.tickets, transactions: state.transactions, auditLog: state.auditLog, counters: state.counters }
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `repairflow-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            State.update({ settings: { ...state.settings, lastBackup: new Date().toISOString() } });
            AuditService.log('system', null, 'create', 'Backup created');
            Toast.success('Backup downloaded successfully');
            this.render();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.version || !data.data) throw new Error('Invalid backup format');
                    this.pendingBackupData = data;
                    document.getElementById('restore-preview').classList.remove('hidden');
                    document.getElementById('preview-version').textContent = data.version;
                    document.getElementById('preview-date').textContent = Utils.formatDate(data.created_at, true);
                    document.getElementById('preview-inventory').textContent = data.data.inventory?.length || 0;
                    document.getElementById('preview-tickets').textContent = data.data.tickets?.length || 0;
                    document.getElementById('preview-transactions').textContent = data.data.transactions?.length || 0;
                    document.getElementById('restore-btn').disabled = false;
                } catch (err) {
                    Toast.error('Invalid backup file');
                    this.pendingBackupData = null;
                }
            };
            reader.readAsText(file);
        },
        
        confirmRestore() {
            if (!this.pendingBackupData) return;
            Modal.show('confirm-restore-modal-template');
        },
        
        executeRestore() {
            const input = document.getElementById('restore-confirm-input').value;
            if (input !== 'RESTORE') { Toast.error('Please type RESTORE to confirm'); return; }
            if (!this.pendingBackupData) return;
            const newState = { ...State.getDefaultState(), ...this.pendingBackupData.data, settings: { lastBackup: null } };
            State.replaceState(newState);
            AuditService.log('system', null, 'update', 'Data restored from backup');
            Modal.close();
            Toast.success('Data restored successfully');
            this.pendingBackupData = null;
            document.getElementById('restore-preview').classList.add('hidden');
            document.getElementById('restore-btn').disabled = true;
            App.refresh();
        },
        
        clearAllData() { Modal.show('clear-data-modal-template'); },
        
        executeClear() {
            const input = document.getElementById('clear-confirm-input').value;
            if (input !== 'DELETE ALL') { Toast.error('Please type DELETE ALL to confirm'); return; }
            State.clear();
            Modal.close();
            Toast.success('All data cleared');
            App.refresh();
        }
    };

    // ============================================
    // AUTHENTICATION MODULE
    // ============================================
    const Auth = {
        PASSWORD_KEY: 'repairflow_password',
        SESSION_KEY: 'repairflow_session',
        DEFAULT_PASSWORD: 'admin',
        
        init() {
            // Set default password if not exists
            if (!localStorage.getItem(this.PASSWORD_KEY)) {
                localStorage.setItem(this.PASSWORD_KEY, this.DEFAULT_PASSWORD);
            }
            // Initialize ApiService
            ApiService.init();
        },
        
        isLoggedIn() {
            // Check both session and API token
            return sessionStorage.getItem(this.SESSION_KEY) === 'true' || !!ApiService.token;
        },
        
        async login(username, password) {
            // Try API login first
            if (USE_API) {
                try {
                    const response = await ApiService.post('/api/auth/login', { username, password });
                    if (response && response.token) {
                        ApiService.setToken(response.token);
                        sessionStorage.setItem(this.SESSION_KEY, 'true');
                        sessionStorage.setItem('user_info', JSON.stringify(response.user));
                        return true;
                    }
                } catch (error) {
                    console.warn('API login failed, trying local:', error.message);
                }
            }
            
            // Fallback to local login
            const storedPassword = localStorage.getItem(this.PASSWORD_KEY) || this.DEFAULT_PASSWORD;
            if (password === storedPassword || (username === 'admin' && password === 'admin')) {
                sessionStorage.setItem(this.SESSION_KEY, 'true');
                return true;
            }
            return false;
        },
        
        logout() {
            sessionStorage.removeItem(this.SESSION_KEY);
            sessionStorage.removeItem('user_info');
            ApiService.clearToken();
            SyncManager.destroy();
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        },
        
        async handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            
            const success = await this.login(username, password);
            if (success) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                App.initAfterLogin();
                errorEl.classList.add('hidden');
            } else {
                errorEl.textContent = 'Invalid username or password. Please try again.';
                errorEl.classList.remove('hidden');
            }
        },
        
        goToPublicTracking() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.querySelector('.sidebar').classList.add('hidden');
            document.querySelector('.main-content').style.marginLeft = '0';
            App.publicMode = true;
            App.navigate('tracking');
        },
        
        goToPublicTradeIn() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.querySelector('.sidebar').classList.add('hidden');
            document.querySelector('.main-content').style.marginLeft = '0';
            App.publicMode = true;
            App.navigate('public-tradein');
        },
        
        changePassword(oldPassword, newPassword) {
            const storedPassword = localStorage.getItem(this.PASSWORD_KEY) || this.DEFAULT_PASSWORD;
            if (oldPassword === storedPassword) {
                localStorage.setItem(this.PASSWORD_KEY, newPassword);
                Toast.success('Password changed successfully');
                return true;
            }
            Toast.error('Current password is incorrect');
            return false;
        }
    };

    // ============================================
    // MAIN APPLICATION
    // ============================================
    const App = {
        currentView: 'dashboard',
        publicMode: false,
        
        init() {
            State.init();
            Modal.init();
            Auth.init();
            
            // Check if already logged in
            if (Auth.isLoggedIn()) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                this.initAfterLogin();
            }
        },
        
        initAfterLogin() {
            RepricingEngine.applyRepricing();
            this.navigate('dashboard');
            AuditService.log('system', null, 'create', 'User logged in');
            setInterval(() => RepricingEngine.applyRepricing(), 3600000);
        },
        
        navigate(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${view}`)?.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-slate-800');
                if (btn.dataset.nav === view) btn.classList.add('bg-slate-800');
            });
            this.currentView = view;
            this.refresh();
        },
        
        refresh() {
            switch(this.currentView) {
                case 'dashboard': DashboardUI.render(); break;
                case 'inventory': InventoryUI.render(); break;
                case 'trade': TradeUI.render(); break;
                case 'service': ServiceUI.render(); break;
                case 'finance': FinanceUI.render(); break;
                case 'forecast': ForecastUI.render(); break;
                case 'audit': AuditUI.render(); break;
                case 'backup': BackupUI.render(); break;
            }
            document.getElementById('inventory-count').textContent = InventoryService.getAvailable().length;
            document.getElementById('service-count').textContent = ServiceTicketService.getActive().length;
        }
    };

    // ============================================
    // PARTS INVENTORY SERVICE
    // ============================================
    const PartsInventoryService = {
        STORAGE_KEY: 'repairflow_parts_inventory',
        
        getAll() {
            const state = State.get();
            return state.partsInventory || [];
        },
        
        getById(id) {
            return this.getAll().find(p => p.id === id);
        },
        
        findPart(device_id, part_type_id, quality, color) {
            return this.getAll().find(p => 
                p.device_id === device_id && 
                p.part_type_id === part_type_id && 
                p.quality === quality &&
                p.color === color
            );
        },
        
        add(partData) {
            const state = State.get();
            const existing = this.findPart(partData.device_id, partData.part_type_id, partData.quality, partData.color);
            
            if (existing) {
                // Update existing part
                return this.update(existing.id, {
                    quantity: existing.quantity + parseInt(partData.quantity),
                    cost_price: parseFloat(partData.cost_price),
                    sell_price: parseFloat(partData.sell_price),
                    notes: partData.notes || existing.notes
                });
            }
            
            const part = {
                id: Utils.generateId('prt'),
                device_id: partData.device_id,
                part_type_id: partData.part_type_id,
                quality: partData.quality,
                color: partData.color || '',
                quantity: parseInt(partData.quantity) || 0,
                cost_price: parseFloat(partData.cost_price) || 0,
                sell_price: parseFloat(partData.sell_price) || 0,
                notes: partData.notes || '',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            const partsInventory = [...(state.partsInventory || []), part];
            State.update({ partsInventory });
            
            const device = IPHONE_DEVICES.find(d => d.id === part.device_id);
            const partType = IPHONE_PART_TYPES.find(p => p.id === part.part_type_id);
            
            AuditService.log('inventory', part.id, 'create',
                `Added part: ${device?.name} - ${partType?.name}`,
                { quantity: part.quantity, cost: part.cost_price }
            );
            
            return part;
        },
        
        update(id, changes) {
            const state = State.get();
            const partsInventory = (state.partsInventory || []).map(p =>
                p.id === id ? { ...p, ...changes, updated_at: new Date().toISOString() } : p
            );
            State.update({ partsInventory });
            return this.getById(id);
        },
        
        delete(id) {
            const state = State.get();
            const partsInventory = (state.partsInventory || []).filter(p => p.id !== id);
            State.update({ partsInventory });
            AuditService.log('inventory', id, 'delete', 'Part deleted from inventory');
        },
        
        adjustQuantity(id, adjustment) {
            const part = this.getById(id);
            if (!part) return null;
            const newQty = Math.max(0, part.quantity + adjustment);
            return this.update(id, { quantity: newQty });
        },
        
        getStats() {
            const parts = this.getAll();
            const inStock = parts.filter(p => p.quantity > 0);
            const outOfStock = parts.filter(p => p.quantity === 0);
            const totalValue = parts.reduce((sum, p) => sum + (p.quantity * p.cost_price), 0);
            
            return {
                totalTypes: parts.length,
                inStock: inStock.length,
                outOfStock: outOfStock.length,
                totalValue
            };
        },
        
        initializeDefaultParts() {
            const state = State.get();
            if ((state.partsInventory || []).length > 0) {
                Toast.warning('Parts inventory already has items. Clear first if you want to reinitialize.');
                return;
            }
            
            const partsInventory = [];
            
            // Create parts for popular devices with quantity 0
            const popularDevices = IPHONE_DEVICES.filter(d => d.year >= 2020);
            const commonParts = IPHONE_PART_TYPES.filter(p => 
                ['display_oled', 'display_lcd', 'battery', 'back_glass', 'charging_port', 'rear_camera_module', 'front_camera', 'ear_speaker', 'loudspeaker', 'taptic_engine'].includes(p.id)
            );
            
            popularDevices.forEach(device => {
                commonParts.forEach(partType => {
                    // Add original quality
                    partsInventory.push({
                        id: Utils.generateId('prt'),
                        device_id: device.id,
                        part_type_id: partType.id,
                        quality: 'original',
                        color: '',
                        quantity: 0,
                        cost_price: 0,
                        sell_price: 0,
                        notes: '',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    
                    // Add aftermarket for displays
                    if (partType.category === 'display') {
                        partsInventory.push({
                            id: Utils.generateId('prt'),
                            device_id: device.id,
                            part_type_id: partType.id,
                            quality: 'aftermarket_high',
                            color: '',
                            quantity: 0,
                            cost_price: 0,
                            sell_price: 0,
                            notes: '',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    }
                });
            });
            
            State.update({ partsInventory });
            AuditService.log('system', null, 'create', `Initialized parts catalog with ${partsInventory.length} items`);
            Toast.success(`Initialized ${partsInventory.length} part types for ${popularDevices.length} devices`);
            
            return partsInventory.length;
        }
    };

    // ============================================
    // PARTS INVENTORY UI
    // ============================================
    const PartsInventoryUI = {
        currentEditPart: null,
        
        render() {
            this.updateStats();
            this.populateFilters();
            this.applyFilters();
            
            const stats = PartsInventoryService.getStats();
            document.getElementById('parts-inventory-count').textContent = stats.inStock;
        },
        
        updateStats() {
            const stats = PartsInventoryService.getStats();
            document.getElementById('parts-total-items').textContent = stats.totalTypes;
            document.getElementById('parts-in-stock').textContent = stats.inStock;
            document.getElementById('parts-out-of-stock').textContent = stats.outOfStock;
            document.getElementById('parts-total-value').textContent = Utils.formatCurrency(stats.totalValue);
        },
        
        onDeviceTypeFilterChange() {
            const deviceType = document.getElementById('parts-filter-type')?.value || '';
            this.populateFilters(deviceType);
            this.applyFilters();
        },
        
        populateFilters(deviceType = '') {
            const deviceSelect = document.getElementById('parts-filter-device');
            const categorySelect = document.getElementById('parts-filter-category');
            
            // Ensure data is loaded
            const phones = DataLoader.isLoaded ? PHONE_DEVICES : [];
            const consoles = DataLoader.isLoaded ? CONSOLE_DEVICES : [];
            const phoneParts = DataLoader.isLoaded ? IPHONE_PART_TYPES : [];
            const consoleParts = DataLoader.isLoaded ? CONSOLE_PART_TYPES : [];
            const consoleCategories = DataLoader.isLoaded ? CONSOLE_PART_CATEGORIES : [];
            
            // Populate device dropdown based on type filter
            if (deviceSelect) {
                if (deviceType === 'console') {
                    deviceSelect.innerHTML = '<option value="">All Consoles</option>' +
                        consoles.map(d => `<option value="${d.id}">${d.brand} ${d.name}</option>`).join('');
                } else if (deviceType === 'phone') {
                    deviceSelect.innerHTML = '<option value="">All Phones</option>' +
                        phones.map(d => `<option value="${d.id}">${d.name} (${d.year})</option>`).join('');
                } else {
                    // All types - show both
                    deviceSelect.innerHTML = '<option value="">All Devices</option>' +
                        '<optgroup label="📱 Phones">' +
                        PHONE_DEVICES.map(d => `<option value="${d.id}">${d.name} (${d.year})</option>`).join('') +
                        '</optgroup>' +
                        '<optgroup label="🎮 Gaming Consoles">' +
                        CONSOLE_DEVICES.map(d => `<option value="${d.id}">${d.brand} ${d.name}</option>`).join('') +
                        '</optgroup>';
                }
            }
            
            // Populate category dropdown based on type filter
            if (categorySelect) {
                if (deviceType === 'console') {
                    categorySelect.innerHTML = '<option value="">All Categories</option>' +
                        CONSOLE_PART_CATEGORIES.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
                } else if (deviceType === 'phone') {
                    const phoneCategories = [
                        { id: 'display', name: 'Display', icon: '📱' },
                        { id: 'battery', name: 'Battery', icon: '🔋' },
                        { id: 'housing', name: 'Housing', icon: '🏠' },
                        { id: 'back_glass', name: 'Back Glass', icon: '🪟' },
                        { id: 'camera', name: 'Camera', icon: '📷' },
                        { id: 'charging', name: 'Charging', icon: '🔌' },
                        { id: 'speaker', name: 'Speaker', icon: '🔊' },
                        { id: 'buttons', name: 'Buttons', icon: '🔘' },
                        { id: 'sensors', name: 'Sensors', icon: '📡' },
                        { id: 'other', name: 'Other', icon: '🔧' }
                    ];
                    categorySelect.innerHTML = '<option value="">All Categories</option>' +
                        phoneCategories.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
                } else {
                    // All types - combine categories
                    const allCategories = [
                        { group: 'Phone Parts', items: [
                            { id: 'display', name: 'Display', icon: '📱' },
                            { id: 'battery', name: 'Battery', icon: '🔋' },
                            { id: 'housing', name: 'Housing', icon: '🏠' },
                            { id: 'back_glass', name: 'Back Glass', icon: '🪟' },
                            { id: 'camera', name: 'Camera', icon: '📷' },
                            { id: 'charging', name: 'Charging', icon: '🔌' },
                            { id: 'speaker', name: 'Speaker', icon: '🔊' },
                            { id: 'buttons', name: 'Buttons', icon: '🔘' },
                            { id: 'sensors', name: 'Sensors', icon: '📡' }
                        ]},
                        { group: 'Console Parts', items: CONSOLE_PART_CATEGORIES }
                    ];
                    categorySelect.innerHTML = '<option value="">All Categories</option>' +
                        allCategories.map(g => 
                            `<optgroup label="${g.group}">${g.items.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('')}</optgroup>`
                        ).join('') +
                        '<option value="other">🔧 Other</option>';
                }
            }
        },
        
        applyFilters() {
            const device = document.getElementById('parts-filter-device')?.value || '';
            const category = document.getElementById('parts-filter-category')?.value || '';
            const stock = document.getElementById('parts-filter-stock')?.value || '';
            const search = document.getElementById('parts-filter-search')?.value?.toLowerCase() || '';
            
            let parts = PartsInventoryService.getAll();
            
            if (device) parts = parts.filter(p => p.device_id === device);
            if (category) {
                const partTypesInCategory = IPHONE_PART_TYPES.filter(pt => pt.category === category).map(pt => pt.id);
                parts = parts.filter(p => partTypesInCategory.includes(p.part_type_id));
            }
            if (stock === 'in_stock') parts = parts.filter(p => p.quantity > 0);
            if (stock === 'low_stock') parts = parts.filter(p => p.quantity > 0 && p.quantity <= 5);
            if (stock === 'out_of_stock') parts = parts.filter(p => p.quantity === 0);
            if (search) {
                parts = parts.filter(p => {
                    const device = IPHONE_DEVICES.find(d => d.id === p.device_id);
                    const partType = IPHONE_PART_TYPES.find(pt => pt.id === p.part_type_id);
                    return device?.name.toLowerCase().includes(search) || 
                           partType?.name.toLowerCase().includes(search);
                });
            }
            
            this.renderTable(parts);
        },
        
        renderTable(parts) {
            const tbody = document.getElementById('parts-inventory-table-body');
            
            if (!DataLoader.isLoaded) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-12 text-slate-400">Loading data... Please wait.</td></tr>';
                return;
            }
            
            if (!parts || parts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-12 text-slate-400">No parts in inventory. Click "Initialize Parts Catalog" to add default parts.</td></tr>';
                return;
            }
            
            const categoryColors = {
                display: 'blue', battery: 'green', housing: 'purple', back_glass: 'pink',
                camera: 'orange', charging: 'yellow', speaker: 'red', buttons: 'indigo',
                sensors: 'cyan', other: 'slate', power: 'yellow', cooling: 'blue',
                optical: 'pink', storage: 'indigo', board: 'green', cables: 'orange', controller: 'red'
            };
            
            const qualityColors = {
                original: 'green', refurbished: 'blue', aftermarket_high: 'yellow', aftermarket_standard: 'orange'
            };
            
            tbody.innerHTML = parts.map(part => {
                // Check both phone and console devices
                let device = PHONE_DEVICES.find(d => d.id === part.device_id);
                if (!device) {
                    device = CONSOLE_DEVICES.find(d => d.id === part.device_id);
                }
                
                // Check both phone and console part types
                let partType = IPHONE_PART_TYPES.find(pt => pt.id === part.part_type_id);
                if (!partType) {
                    partType = CONSOLE_PART_TYPES.find(pt => pt.id === part.part_type_id);
                }
                
                const quality = QUALITY_TYPES.find(q => q.id === part.quality);
                const color = COLOR_OPTIONS.find(c => c.id === part.color);
                
                const stockClass = part.quantity === 0 ? 'bg-red-100 text-red-700' : 
                                  part.quantity <= 5 ? 'bg-yellow-100 text-yellow-700' : 
                                  'bg-green-100 text-green-700';
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4">
                            <p class="font-medium text-slate-800">${device?.name || 'Unknown'}</p>
                            <p class="text-xs text-slate-500">${device?.year || ''}</p>
                        </td>
                        <td class="px-6 py-4">
                            <p class="font-medium text-slate-700">${partType?.name || 'Unknown'}</p>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${categoryColors[partType?.category] || 'slate'}-100 text-${categoryColors[partType?.category] || 'slate'}-700">
                                ${partType?.category || 'other'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${qualityColors[part.quality] || 'slate'}-100 text-${qualityColors[part.quality] || 'slate'}-700">
                                ${quality?.name || part.quality}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">
                            ${color?.name || part.color || '-'}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-sm font-bold ${stockClass}">${part.quantity}</span>
                        </td>
                        <td class="px-6 py-4 text-right text-sm text-slate-600">${Utils.formatCurrency(part.cost_price)}</td>
                        <td class="px-6 py-4 text-right text-sm font-medium text-slate-800">${Utils.formatCurrency(part.sell_price)}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="PartsInventoryUI.showEditModal('${part.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        },
        
        showAddStockModal() {
            Modal.show('add-stock-modal-template');
            
            if (!DataLoader.isLoaded) {
                Toast.warning('Data is still loading. Please wait...');
                return;
            }
            
            // Populate device select - include both phones and consoles
            const deviceSelect = document.getElementById('stock-device');
            deviceSelect.innerHTML = '<option value="">Select Device</option>' +
                '<optgroup label="📱 Phones">' +
                PHONE_DEVICES.map(d => `<option value="${d.id}">${d.name} (${d.year})</option>`).join('') +
                '</optgroup>' +
                '<optgroup label="🎮 Gaming Consoles">' +
                CONSOLE_DEVICES.map(d => `<option value="${d.id}">${d.brand} ${d.name}</option>`).join('') +
                '</optgroup>';
            
            // Setup device change handler to update part types
            deviceSelect.onchange = () => this.onStockDeviceChange();
            
            // Populate part type select with all types initially
            const partTypeSelect = document.getElementById('stock-part-type');
            partTypeSelect.innerHTML = '<option value="">Select Part Type</option>' +
                '<optgroup label="📱 Phone Parts">' +
                IPHONE_PART_TYPES.map(pt => `<option value="${pt.id}">${pt.name} (${pt.category})</option>`).join('') +
                '</optgroup>' +
                '<optgroup label="🎮 Console Parts">' +
                CONSOLE_PART_TYPES.map(pt => `<option value="${pt.id}">${pt.name} (${pt.category})</option>`).join('') +
                '</optgroup>';
        },
        
        onStockDeviceChange() {
            const deviceSelect = document.getElementById('stock-device');
            const partTypeSelect = document.getElementById('stock-part-type');
            const deviceId = deviceSelect.value;
            
            // Determine if selected device is phone or console
            const isPhone = PHONE_DEVICES.some(d => d.id === deviceId);
            const isConsole = CONSOLE_DEVICES.some(d => d.id === deviceId);
            
            if (isPhone) {
                partTypeSelect.innerHTML = '<option value="">Select Part Type</option>' +
                    IPHONE_PART_TYPES.map(pt => `<option value="${pt.id}">${pt.name} (${pt.category})</option>`).join('');
            } else if (isConsole) {
                partTypeSelect.innerHTML = '<option value="">Select Part Type</option>' +
                    CONSOLE_PART_TYPES.map(pt => `<option value="${pt.id}">${pt.name} (${pt.category})</option>`).join('');
            } else {
                // Show all
                partTypeSelect.innerHTML = '<option value="">Select Part Type</option>' +
                    '<optgroup label="📱 Phone Parts">' +
                    IPHONE_PART_TYPES.map(pt => `<option value="${pt.id}">${pt.name} (${pt.category})</option>`).join('') +
                    '</optgroup>' +
                    '<optgroup label="🎮 Console Parts">' +
                    CONSOLE_PART_TYPES.map(pt => `<option value="${pt.id}">${pt.name} (${pt.category})</option>`).join('') +
                    '</optgroup>';
            }
        },
        
        handleAddStock(event) {
            event.preventDefault();
            
            const partData = {
                device_id: document.getElementById('stock-device').value,
                part_type_id: document.getElementById('stock-part-type').value,
                quality: document.getElementById('stock-quality').value,
                color: document.getElementById('stock-color').value,
                quantity: document.getElementById('stock-quantity').value,
                cost_price: document.getElementById('stock-cost').value,
                sell_price: document.getElementById('stock-sell').value,
                notes: document.getElementById('stock-notes').value
            };
            
            if (!partData.device_id || !partData.part_type_id) {
                Toast.error('Please select device and part type');
                return;
            }
            
            PartsInventoryService.add(partData);
            Toast.success('Stock added/updated successfully');
            Modal.close();
            this.render();
        },
        
        showEditModal(partId) {
            const part = PartsInventoryService.getById(partId);
            if (!part) return;
            
            this.currentEditPart = part;
            Modal.show('edit-part-modal-template');
            
            const device = IPHONE_DEVICES.find(d => d.id === part.device_id);
            const partType = IPHONE_PART_TYPES.find(pt => pt.id === part.part_type_id);
            
            document.getElementById('edit-part-name').textContent = partType?.name || 'Unknown Part';
            document.getElementById('edit-part-device').textContent = device?.name || 'Unknown Device';
            document.getElementById('edit-quantity').value = part.quantity;
            document.getElementById('edit-cost').value = part.cost_price.toFixed(2);
            document.getElementById('edit-sell').value = part.sell_price.toFixed(2);
        },
        
        adjustQuantity(delta) {
            const input = document.getElementById('edit-quantity');
            const current = parseInt(input.value) || 0;
            input.value = Math.max(0, current + delta);
        },
        
        handleEditPart(event) {
            event.preventDefault();
            if (!this.currentEditPart) return;
            
            const changes = {
                quantity: parseInt(document.getElementById('edit-quantity').value) || 0,
                cost_price: parseFloat(document.getElementById('edit-cost').value) || 0,
                sell_price: parseFloat(document.getElementById('edit-sell').value) || 0
            };
            
            PartsInventoryService.update(this.currentEditPart.id, changes);
            Toast.success('Part updated successfully');
            Modal.close();
            this.currentEditPart = null;
            this.render();
        },
        
        initializeDefaultParts() {
            if (confirm('This will initialize the parts catalog with default iPhone parts (all with quantity 0). Continue?')) {
                PartsInventoryService.initializeDefaultParts();
                this.render();
            }
        }
    };

    // ============================================
    // TRADE-IN SERVICE
    // ============================================
    const TradeInService = {
        STATUSES: [
            { key: 'pending', label: 'Pending Review', color: 'yellow' },
            { key: 'quoted', label: 'Quote Sent', color: 'blue' },
            { key: 'accepted', label: 'Quote Accepted', color: 'purple' },
            { key: 'received', label: 'Device Received', color: 'indigo' },
            { key: 'completed', label: 'Completed', color: 'green' },
            { key: 'rejected', label: 'Rejected', color: 'red' }
        ],
        
        generateRefId() {
            const state = State.get();
            const nextNum = (state.counters?.tradeinCounter || 0) + 1;
            State.update({ counters: { ...state.counters, tradeinCounter: nextNum } });
            return `TRD-${String(nextNum).padStart(4, '0')}`;
        },
        
        getAll() {
            const state = State.get();
            return state.tradeinRequests || [];
        },
        
        getById(id) {
            return this.getAll().find(t => t.id === id);
        },
        
        getPending() {
            return this.getAll().filter(t => t.status === 'pending');
        },
        
        create(data) {
            const state = State.get();
            const request = {
                id: this.generateRefId(),
                customer: {
                    name: data.name,
                    id_number: data.id_number,
                    email: data.email,
                    phone: data.phone,
                    iban: data.iban,
                    address: data.address || ''
                },
                device: {
                    type: data.device_type,
                    model: data.model,
                    imei: data.imei || '',
                    condition: data.condition,
                    details: data.details || ''
                },
                delivery_method: data.delivery_method,
                photos: data.photos || [],
                status: 'pending',
                offer_amount: 0,
                notes: [],
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            const tradeinRequests = [...(state.tradeinRequests || []), request];
            State.update({ tradeinRequests });
            
            AuditService.log('tradein', request.id, 'create',
                `Trade-in request created: ${request.device.model}`,
                { customer: request.customer.name, device: request.device.model }
            );
            
            return request;
        },
        
        update(id, changes) {
            const state = State.get();
            const tradeinRequests = (state.tradeinRequests || []).map(t =>
                t.id === id ? { ...t, ...changes, updated_at: new Date().toISOString() } : t
            );
            State.update({ tradeinRequests });
            return this.getById(id);
        },
        
        updateStatus(id, newStatus) {
            const request = this.getById(id);
            if (!request) return null;
            
            this.update(id, { status: newStatus });
            
            AuditService.log('tradein', id, 'status_change',
                `Trade-in status: ${request.status} → ${newStatus}`,
                { old_status: request.status, new_status: newStatus }
            );
            
            return this.getById(id);
        },
        
        setOffer(id, amount) {
            const request = this.getById(id);
            if (!request) return null;
            
            this.update(id, { offer_amount: parseFloat(amount), status: 'quoted' });
            
            AuditService.log('tradein', id, 'update',
                `Quote sent: ${Utils.formatCurrency(amount)}`,
                { offer_amount: amount }
            );
            
            return this.getById(id);
        },
        
        addNote(id, noteText) {
            const request = this.getById(id);
            if (!request) return null;
            
            const note = {
                id: Utils.generateId('note'),
                text: noteText,
                timestamp: new Date().toISOString()
            };
            
            this.update(id, { notes: [...(request.notes || []), note] });
            return this.getById(id);
        },
        
        getStatusCounts() {
            const requests = this.getAll();
            const counts = {};
            this.STATUSES.forEach(s => {
                counts[s.key] = requests.filter(t => t.status === s.key).length;
            });
            return counts;
        }
    };

    // ============================================
    // PUBLIC TRADE-IN UI
    // ============================================
    const PublicTradeInUI = {
        selectedPhotos: [],
        
        init() {
            // Setup delivery method toggle
            document.querySelectorAll('input[name="tradein-delivery"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const shippingSection = document.getElementById('shipping-address-section');
                    if (e.target.value === 'shipping') {
                        shippingSection.classList.remove('hidden');
                    } else {
                        shippingSection.classList.add('hidden');
                    }
                });
            });
        },
        
        handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            const previewContainer = document.getElementById('tradein-photo-preview');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.selectedPhotos.push(e.target.result);
                    this.renderPhotoPreview();
                };
                reader.readAsDataURL(file);
            });
        },
        
        renderPhotoPreview() {
            const container = document.getElementById('tradein-photo-preview');
            container.innerHTML = this.selectedPhotos.map((photo, index) => `
                <div class="relative">
                    <img src="${photo}" class="w-full h-24 object-cover rounded-lg">
                    <button type="button" onclick="PublicTradeInUI.removePhoto(${index})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs">×</button>
                </div>
            `).join('');
        },
        
        removePhoto(index) {
            this.selectedPhotos.splice(index, 1);
            this.renderPhotoPreview();
        },
        
        handleSubmit(event) {
            event.preventDefault();
            
            const deliveryMethod = document.querySelector('input[name="tradein-delivery"]:checked')?.value;
            
            const data = {
                name: document.getElementById('tradein-name').value.trim(),
                id_number: document.getElementById('tradein-id-number').value.trim(),
                email: document.getElementById('tradein-email').value.trim(),
                phone: document.getElementById('tradein-phone').value.trim(),
                device_type: document.getElementById('tradein-device-type').value,
                model: document.getElementById('tradein-model').value.trim(),
                imei: document.getElementById('tradein-imei').value.trim(),
                condition: document.getElementById('tradein-condition').value,
                details: document.getElementById('tradein-details').value.trim(),
                delivery_method: deliveryMethod,
                address: document.getElementById('tradein-address')?.value.trim() || '',
                iban: document.getElementById('tradein-iban').value.trim(),
                photos: this.selectedPhotos
            };
            
            // Validate IBAN
            if (!data.iban || data.iban.length < 15) {
                Toast.error('Please enter a valid IBAN');
                return;
            }
            
            // Create trade-in request
            const request = TradeInService.create(data);
            
            // Show success message
            document.getElementById('public-tradein-form').classList.add('hidden');
            document.getElementById('tradein-success').classList.remove('hidden');
            document.getElementById('tradein-ref-number').textContent = request.id;
            
            Toast.success('Trade-in request submitted successfully!');
        },
        
        resetForm() {
            document.getElementById('public-tradein-form').reset();
            document.getElementById('public-tradein-form').classList.remove('hidden');
            document.getElementById('tradein-success').classList.add('hidden');
            document.getElementById('tradein-photo-preview').innerHTML = '';
            document.getElementById('shipping-address-section').classList.add('hidden');
            this.selectedPhotos = [];
        }
    };

    // ============================================
    // TRADE-IN REQUESTS UI (Admin)
    // ============================================
    const TradeInRequestsUI = {
        currentRequest: null,
        
        render() {
            this.updateStatusCounts();
            this.applyFilters();
            
            const pending = TradeInService.getPending();
            document.getElementById('tradein-requests-count').textContent = pending.length;
        },
        
        updateStatusCounts() {
            const counts = TradeInService.getStatusCounts();
            document.getElementById('tradein-status-pending').textContent = counts.pending || 0;
            document.getElementById('tradein-status-quoted').textContent = counts.quoted || 0;
            document.getElementById('tradein-status-received').textContent = counts.received || 0;
            document.getElementById('tradein-status-completed').textContent = counts.completed || 0;
            document.getElementById('tradein-status-rejected').textContent = counts.rejected || 0;
        },
        
        applyFilters() {
            const status = document.getElementById('tradein-filter-status')?.value || '';
            const search = document.getElementById('tradein-search')?.value?.toLowerCase() || '';
            
            let requests = TradeInService.getAll();
            
            if (status) requests = requests.filter(r => r.status === status);
            if (search) {
                requests = requests.filter(r =>
                    r.id.toLowerCase().includes(search) ||
                    r.customer.name.toLowerCase().includes(search) ||
                    r.customer.email.toLowerCase().includes(search) ||
                    r.device.model.toLowerCase().includes(search)
                );
            }
            
            // Sort by date, newest first
            requests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            this.renderList(requests);
        },
        
        renderList(requests) {
            const container = document.getElementById('tradein-requests-list');
            
            if (requests.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-slate-400">No trade-in requests</div>';
                return;
            }
            
            container.innerHTML = requests.map(r => {
                const status = TradeInService.STATUSES.find(s => s.key === r.status);
                const conditionLabels = {
                    excellent: 'Excellent',
                    good: 'Good',
                    fair: 'Fair',
                    poor: 'Poor',
                    broken: 'Broken'
                };
                
                return `
                    <div class="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer" onclick="TradeInRequestsUI.showDetails('${r.id}')">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="text-lg font-bold text-green-600">${r.id.split('-')[1]}</span>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-medium text-slate-800">${r.device.model}</p>
                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600">${conditionLabels[r.device.condition] || r.device.condition}</span>
                                </div>
                                <p class="text-sm text-slate-500">${r.customer.name} • ${Utils.formatRelativeTime(r.created_at)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-${status.color}-100 text-${status.color}-700">${status.label}</span>
                            ${r.offer_amount > 0 ? `<p class="text-sm font-medium text-green-600 mt-1">${Utils.formatCurrency(r.offer_amount)}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        },
        
        showDetails(requestId) {
            const request = TradeInService.getById(requestId);
            if (!request) return;
            
            this.currentRequest = request;
            Modal.show('tradein-details-modal-template');
            
            const status = TradeInService.STATUSES.find(s => s.key === request.status);
            const conditionLabels = {
                excellent: 'Excellent - Like new',
                good: 'Good - Minor scratches',
                fair: 'Fair - Visible wear',
                poor: 'Poor - Significant damage',
                broken: 'Broken / Not working'
            };
            const deliveryLabels = { in_person: 'In Person', shipping: 'Ship to Us' };
            const deviceTypes = { iphone: 'iPhone', ipad: 'iPad', macbook: 'MacBook', android: 'Android Phone', tablet: 'Android Tablet', laptop: 'Other Laptop', other: 'Other' };
            
            // Populate modal
            document.getElementById('tradein-modal-ref').textContent = request.id;
            document.getElementById('tradein-modal-date').textContent = Utils.formatDate(request.created_at, true);
            document.getElementById('tradein-modal-name').textContent = request.customer.name;
            document.getElementById('tradein-modal-idnum').textContent = request.customer.id_number;
            document.getElementById('tradein-modal-email').textContent = request.customer.email;
            document.getElementById('tradein-modal-phone').textContent = request.customer.phone;
            document.getElementById('tradein-modal-iban').textContent = request.customer.iban;
            document.getElementById('tradein-modal-type').textContent = deviceTypes[request.device.type] || request.device.type;
            document.getElementById('tradein-modal-model').textContent = request.device.model;
            document.getElementById('tradein-modal-imei').textContent = request.device.imei || 'N/A';
            document.getElementById('tradein-modal-condition').textContent = conditionLabels[request.device.condition] || request.device.condition;
            document.getElementById('tradein-modal-delivery').textContent = deliveryLabels[request.delivery_method] || request.delivery_method;
            document.getElementById('tradein-modal-details').textContent = request.device.details || 'No additional details';
            
            // Status badge
            const statusBadge = document.getElementById('tradein-modal-status');
            statusBadge.textContent = status.label;
            statusBadge.className = `px-4 py-2 rounded-full text-sm font-medium bg-${status.color}-100 text-${status.color}-700`;
            
            // Offer
            document.getElementById('tradein-offer-amount').value = request.offer_amount || '';
            document.getElementById('tradein-current-offer').textContent = Utils.formatCurrency(request.offer_amount || 0);
            
            // Photos
            const photosContainer = document.getElementById('tradein-photos-container');
            if (request.photos && request.photos.length > 0) {
                photosContainer.innerHTML = request.photos.map(photo => 
                    `<img src="${photo}" class="w-full h-32 object-cover rounded-lg cursor-pointer" onclick="window.open('${photo}', '_blank')">`
                ).join('');
            } else {
                photosContainer.innerHTML = '<p class="text-sm text-slate-400">No photos uploaded</p>';
            }
            
            // Notes
            const notesContainer = document.getElementById('tradein-modal-notes');
            if (request.notes && request.notes.length > 0) {
                notesContainer.innerHTML = request.notes.map(n =>
                    `<div class="text-sm p-2 bg-white rounded border"><p>${n.text}</p><p class="text-xs text-slate-400 mt-1">${Utils.formatRelativeTime(n.timestamp)}</p></div>`
                ).join('');
            } else {
                notesContainer.innerHTML = '<p class="text-sm text-slate-400">No notes yet</p>';
            }
            
            // Status buttons
            this.renderStatusButtons(request);
        },
        
        renderStatusButtons(request) {
            const container = document.getElementById('tradein-status-buttons');
            const currentIndex = TradeInService.STATUSES.findIndex(s => s.key === request.status);
            
            const buttons = TradeInService.STATUSES.filter(s => s.key !== 'rejected').map((s, i) => {
                const isCurrent = s.key === request.status;
                const isNext = i === currentIndex + 1;
                const isPast = i < currentIndex;
                
                return `
                    <button onclick="TradeInRequestsUI.updateStatus('${s.key}')" 
                        ${isCurrent || isPast ? 'disabled' : ''} 
                        class="py-2 px-3 rounded-lg text-xs font-medium transition-all 
                        ${isCurrent ? 'bg-' + s.color + '-500 text-white' : 
                          isPast ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 
                          isNext ? 'bg-' + s.color + '-100 text-' + s.color + '-700 hover:bg-' + s.color + '-200' : 
                          'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                        ${s.label}
                    </button>
                `;
            }).join('');
            
            container.innerHTML = buttons;
        },
        
        sendQuote() {
            if (!this.currentRequest) return;
            
            const amount = parseFloat(document.getElementById('tradein-offer-amount').value);
            if (!amount || amount <= 0) {
                Toast.error('Please enter a valid offer amount');
                return;
            }
            
            TradeInService.setOffer(this.currentRequest.id, amount);
            Toast.success(`Quote of ${Utils.formatCurrency(amount)} sent`);
            this.showDetails(this.currentRequest.id);
            this.render();
        },
        
        updateStatus(newStatus) {
            if (!this.currentRequest) return;
            
            TradeInService.updateStatus(this.currentRequest.id, newStatus);
            const statusLabel = TradeInService.STATUSES.find(s => s.key === newStatus)?.label;
            Toast.success(`Status updated to ${statusLabel}`);
            this.showDetails(this.currentRequest.id);
            this.render();
        },
        
        addNote() {
            if (!this.currentRequest) return;
            
            const noteText = document.getElementById('tradein-new-note').value.trim();
            if (!noteText) return;
            
            TradeInService.addNote(this.currentRequest.id, noteText);
            document.getElementById('tradein-new-note').value = '';
            this.showDetails(this.currentRequest.id);
        },
        
        addToInventory() {
            if (!this.currentRequest) return;
            
            const r = this.currentRequest;
            
            // Add to inventory
            const item = InventoryService.add({
                type: r.device.type === 'iphone' ? 'phone' : r.device.type,
                brand: r.device.type === 'iphone' ? 'Apple' : 'Unknown',
                model: r.device.model,
                serial: r.device.imei || Utils.generateId('SN'),
                source: 'trade-in',
                seller: r.customer.name,
                buy: r.offer_amount,
                base_sell_price: r.offer_amount * 1.3,
                visual: r.device.condition === 'excellent' ? 'A' : r.device.condition === 'good' ? 'B' : r.device.condition === 'fair' ? 'C' : 'D',
                specs: r.device.details
            });
            
            // Create BUY transaction
            TransactionService.add({
                type: 'BUY',
                amount: r.offer_amount,
                profit: 0,
                item_id: item.id,
                description: `Trade-in: ${r.device.model} from ${r.customer.name}`
            });
            
            // Update status to completed
            TradeInService.updateStatus(r.id, 'completed');
            TradeInService.addNote(r.id, `Added to inventory as ${item.id}`);
            
            Toast.success(`${r.device.model} added to inventory`);
            Modal.close();
            this.currentRequest = null;
            this.render();
            App.refresh();
        },
        
        rejectRequest() {
            if (!this.currentRequest) return;
            
            if (confirm('Are you sure you want to reject this trade-in request?')) {
                TradeInService.updateStatus(this.currentRequest.id, 'rejected');
                Toast.warning('Trade-in request rejected');
                Modal.close();
                this.currentRequest = null;
                this.render();
            }
        }
    };

    // ============================================
    // BULK PARTS UI - Add whole device for parts
    // ============================================
    const BulkPartsUI = {
        selectedParts: new Set(),
        currentDevice: null,
        currentDeviceType: null,
        
        showModal() {
            Modal.show('bulk-add-parts-modal-template');
            this.selectedParts.clear();
            this.currentDevice = null;
            this.currentDeviceType = null;
            document.getElementById('bulk-parts-checklist').innerHTML = '<p class="text-slate-400 text-center py-8">Select a device to see available parts</p>';
            this.updateSelectedCount();
        },
        
        onDeviceTypeChange() {
            const type = document.getElementById('bulk-device-type').value;
            const modelSelect = document.getElementById('bulk-device-model');
            this.currentDeviceType = type;
            
            if (type === 'console') {
                modelSelect.innerHTML = '<option value="">Select console...</option>' +
                    CONSOLE_DEVICES.map(d => `<option value="${d.id}">${d.brand} ${d.name}</option>`).join('');
            } else if (type === 'phone') {
                modelSelect.innerHTML = '<option value="">Select phone...</option>' +
                    PHONE_DEVICES.map(d => `<option value="${d.id}">${d.name} (${d.year})</option>`).join('');
            } else {
                modelSelect.innerHTML = '<option value="">Select device first...</option>';
            }
            
            document.getElementById('bulk-parts-checklist').innerHTML = '<p class="text-slate-400 text-center py-8">Select a device to see available parts</p>';
            this.selectedParts.clear();
            this.updateSelectedCount();
        },
        
        onDeviceModelChange() {
            const modelId = document.getElementById('bulk-device-model').value;
            if (!modelId) {
                document.getElementById('bulk-parts-checklist').innerHTML = '<p class="text-slate-400 text-center py-8">Select a device to see available parts</p>';
                return;
            }
            
            this.currentDevice = modelId;
            this.selectedParts.clear();
            
            let parts = [];
            let categories = [];
            
            if (this.currentDeviceType === 'console') {
                parts = CONSOLE_PART_TYPES;
                categories = CONSOLE_PART_CATEGORIES;
            } else if (this.currentDeviceType === 'phone') {
                parts = IPHONE_PART_TYPES;
                categories = [
                    { id: 'display', name: 'Display', icon: '📱' },
                    { id: 'battery', name: 'Battery', icon: '🔋' },
                    { id: 'housing', name: 'Housing', icon: '🏠' },
                    { id: 'back_glass', name: 'Back Glass', icon: '🪟' },
                    { id: 'camera', name: 'Camera', icon: '📷' },
                    { id: 'charging', name: 'Charging', icon: '🔌' },
                    { id: 'speaker', name: 'Speaker', icon: '🔊' },
                    { id: 'buttons', name: 'Buttons', icon: '🔘' },
                    { id: 'sensors', name: 'Sensors', icon: '📡' },
                    { id: 'other', name: 'Other', icon: '🔧' }
                ];
            }
            
            // Select all parts by default
            parts.forEach(p => this.selectedParts.add(p.id));
            
            this.renderPartsChecklist(parts, categories);
            this.updateSelectedCount();
        },
        
        renderPartsChecklist(parts, categories) {
            const container = document.getElementById('bulk-parts-checklist');
            
            const categoryColors = {
                power: 'yellow', cooling: 'blue', housing: 'purple', optical: 'pink',
                storage: 'indigo', board: 'green', cables: 'orange', controller: 'red',
                display: 'blue', battery: 'green', back_glass: 'pink', camera: 'orange',
                charging: 'yellow', speaker: 'red', buttons: 'indigo', sensors: 'cyan', other: 'slate'
            };
            
            let html = '';
            
            categories.forEach(cat => {
                const catParts = parts.filter(p => p.category === cat.id);
                if (catParts.length === 0) return;
                
                html += `
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <div class="bg-${categoryColors[cat.id] || 'slate'}-50 px-4 py-3 flex items-center justify-between">
                            <h4 class="font-semibold text-slate-800 flex items-center gap-2">
                                <span>${cat.icon || '📦'}</span> ${cat.name}
                                <span class="text-xs text-slate-500">(${catParts.length} parts)</span>
                            </h4>
                            <div class="flex gap-2">
                                <button type="button" onclick="BulkPartsUI.selectCategory('${cat.id}')" class="text-xs text-blue-600 hover:text-blue-800">Select All</button>
                                <button type="button" onclick="BulkPartsUI.deselectCategory('${cat.id}')" class="text-xs text-red-600 hover:text-red-800">Deselect All</button>
                            </div>
                        </div>
                        <div class="p-4 grid grid-cols-2 md:grid-cols-3 gap-2">
                `;
                
                catParts.forEach(part => {
                    const isChecked = this.selectedParts.has(part.id);
                    html += `
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-50 cursor-pointer" data-category="${cat.id}">
                            <input type="checkbox" 
                                id="part-${part.id}" 
                                value="${part.id}" 
                                ${isChecked ? 'checked' : ''} 
                                onchange="BulkPartsUI.togglePart('${part.id}')"
                                class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm text-slate-700">${part.name}</span>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },
        
        togglePart(partId) {
            if (this.selectedParts.has(partId)) {
                this.selectedParts.delete(partId);
            } else {
                this.selectedParts.add(partId);
            }
            this.updateSelectedCount();
        },
        
        selectAllParts() {
            const parts = this.currentDeviceType === 'console' ? CONSOLE_PART_TYPES : IPHONE_PART_TYPES;
            parts.forEach(p => {
                this.selectedParts.add(p.id);
                const checkbox = document.getElementById(`part-${p.id}`);
                if (checkbox) checkbox.checked = true;
            });
            this.updateSelectedCount();
        },
        
        deselectAllParts() {
            this.selectedParts.clear();
            document.querySelectorAll('#bulk-parts-checklist input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            this.updateSelectedCount();
        },
        
        selectCategory(categoryId) {
            const parts = this.currentDeviceType === 'console' ? CONSOLE_PART_TYPES : IPHONE_PART_TYPES;
            parts.filter(p => p.category === categoryId).forEach(p => {
                this.selectedParts.add(p.id);
                const checkbox = document.getElementById(`part-${p.id}`);
                if (checkbox) checkbox.checked = true;
            });
            this.updateSelectedCount();
        },
        
        deselectCategory(categoryId) {
            const parts = this.currentDeviceType === 'console' ? CONSOLE_PART_TYPES : IPHONE_PART_TYPES;
            parts.filter(p => p.category === categoryId).forEach(p => {
                this.selectedParts.delete(p.id);
                const checkbox = document.getElementById(`part-${p.id}`);
                if (checkbox) checkbox.checked = false;
            });
            this.updateSelectedCount();
        },
        
        updateSelectedCount() {
            document.getElementById('bulk-selected-count').textContent = this.selectedParts.size;
        },
        
        handleSubmit(event) {
            event.preventDefault();
            
            if (!this.currentDevice) {
                Toast.error('Please select a device');
                return;
            }
            
            if (this.selectedParts.size === 0) {
                Toast.error('Please select at least one part');
                return;
            }
            
            const purchasePrice = parseFloat(document.getElementById('bulk-purchase-price').value) || 0;
            const quality = document.getElementById('bulk-quality').value;
            const supplier = document.getElementById('bulk-supplier').value.trim();
            
            // Calculate per-part price (divide total by number of selected parts)
            const pricePerPart = purchasePrice / this.selectedParts.size;
            
            let addedCount = 0;
            const state = State.get();
            const partsInventory = [...(state.partsInventory || [])];
            
            // Get device name for logging
            let deviceName = '';
            if (this.currentDeviceType === 'console') {
                const device = CONSOLE_DEVICES.find(d => d.id === this.currentDevice);
                deviceName = device ? `${device.brand} ${device.name}` : this.currentDevice;
            } else {
                const device = PHONE_DEVICES.find(d => d.id === this.currentDevice);
                deviceName = device ? device.name : this.currentDevice;
            }
            
            this.selectedParts.forEach(partId => {
                // Check if part already exists
                const existingIndex = partsInventory.findIndex(p => 
                    p.device_id === this.currentDevice && 
                    p.part_type_id === partId && 
                    p.quality === quality
                );
                
                if (existingIndex >= 0) {
                    // Update existing part quantity
                    partsInventory[existingIndex] = {
                        ...partsInventory[existingIndex],
                        quantity: partsInventory[existingIndex].quantity + 1,
                        cost_price: pricePerPart,
                        sell_price: pricePerPart * 1.5, // 50% markup default
                        notes: supplier ? `From ${supplier}` : partsInventory[existingIndex].notes,
                        updated_at: new Date().toISOString()
                    };
                } else {
                    // Add new part
                    partsInventory.push({
                        id: Utils.generateId('prt'),
                        device_id: this.currentDevice,
                        device_type: this.currentDeviceType,
                        part_type_id: partId,
                        quality: quality,
                        color: '',
                        quantity: 1,
                        cost_price: pricePerPart,
                        sell_price: pricePerPart * 1.5,
                        notes: supplier ? `From ${supplier}` : '',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
                addedCount++;
            });
            
            State.update({ partsInventory });
            
            AuditService.log('inventory', null, 'create',
                `Bulk added ${addedCount} parts from ${deviceName}`,
                { device: deviceName, parts_count: addedCount, total_price: purchasePrice }
            );
            
            Toast.success(`Added ${addedCount} parts from ${deviceName} to inventory`);
            Modal.close();
            
            // Refresh parts inventory if we're on that page
            if (App.currentView === 'parts-inventory') {
                PartsInventoryUI.render();
            }
        }
    };

    // Add button to Parts Inventory view to open bulk add modal
    const originalPartsInventoryRender = PartsInventoryUI.render;
    PartsInventoryUI.render = function() {
        originalPartsInventoryRender.call(this);
        
        // Add bulk add button if not already added
        const headerDiv = document.querySelector('#view-parts-inventory > .flex');
        if (headerDiv && !document.getElementById('bulk-add-btn')) {
            const buttonContainer = headerDiv.querySelector('.flex.gap-3');
            if (buttonContainer) {
                const bulkBtn = document.createElement('button');
                bulkBtn.id = 'bulk-add-btn';
                bulkBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center gap-2';
                bulkBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    Add Device for Parts
                `;
                bulkBtn.onclick = () => BulkPartsUI.showModal();
                buttonContainer.insertBefore(bulkBtn, buttonContainer.firstChild);
            }
        }
    };

    // Update App navigate to include parts-inventory and trade-in
    const originalRefresh = App.refresh;
    App.refresh = function() {
        originalRefresh.call(this);
        if (this.currentView === 'parts-inventory') {
            PartsInventoryUI.render();
        }
        if (this.currentView === 'tradein-requests') {
            TradeInRequestsUI.render();
        }
        if (this.currentView === 'public-tradein') {
            PublicTradeInUI.init();
        }
        // Update trade-in counter
        const pending = TradeInService.getPending();
        document.getElementById('tradein-requests-count').textContent = pending.length;
    };

    // ============================================
    // USERS MANAGEMENT UI (Master Admin Only)
    // ============================================
    const UsersUI = {
        currentEditUser: null,
        
        async render() {
            // Only show for master_admin
            const userInfo = JSON.parse(sessionStorage.getItem('user_info') || '{}');
            if (userInfo.role !== 'master_admin') {
                Toast.warning('Access denied. Master Admin required.');
                App.navigate('dashboard');
                return;
            }
            
            await this.loadUsers();
            this.updateUsersCount();
        },
        
        async loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-slate-400">Loading users...</td></tr>';
            
            try {
                const users = await ApiService.get('/api/auth/users');
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-slate-400">No users found</td></tr>';
                    return;
                }
                
                this.renderUsersTable(users);
            } catch (error) {
                console.error('Failed to load users:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-red-400">Failed to load users: ' + error.message + '</td></tr>';
            }
        },
        
        renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            const currentUserId = JSON.parse(sessionStorage.getItem('user_info') || '{}').id;
            
            tbody.innerHTML = users.map(user => {
                const roleColors = { master_admin: 'red', admin: 'blue' };
                const statusColors = { active: 'green', inactive: 'slate' };
                const isCurrentUser = user.id === currentUserId;
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">
                                    ${(user.name || user.username).charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p class="font-medium text-slate-800">${user.name || user.username}</p>
                                    ${isCurrentUser ? '<span class="text-xs text-blue-600">(You)</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 font-mono text-sm text-slate-600">${user.username}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${roleColors[user.role] || 'slate'}-100 text-${roleColors[user.role] || 'slate'}-700">
                                ${user.role === 'master_admin' ? 'Master Admin' : 'Admin'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500">
                            ${user.last_login ? Utils.formatDate(user.last_login, true) : 'Never'}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${statusColors[user.is_active ? 'active' : 'inactive']}-100 text-${statusColors[user.is_active ? 'active' : 'inactive']}-700">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="UsersUI.showEditUserModal('${user.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                                ${!isCurrentUser ? `<button onclick="UsersUI.deleteUser('${user.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        },
        
        updateUsersCount() {
            // Update the badge count if needed
        },
        
        showAddUserModal() {
            this.currentEditUser = null;
            Modal.show('add-user-modal-template');
            
            document.getElementById('user-modal-title').textContent = 'Add New User';
            document.getElementById('user-edit-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-username').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').required = true;
            document.getElementById('password-hint').textContent = '(required)';
            document.getElementById('user-role').value = 'admin';
            document.getElementById('user-active-field').classList.add('hidden');
        },
        
        async showEditUserModal(userId) {
            try {
                const users = await ApiService.get('/api/auth/users');
                const user = users.find(u => u.id.toString() === userId.toString());
                
                if (!user) {
                    Toast.error('User not found');
                    return;
                }
                
                this.currentEditUser = user;
                Modal.show('add-user-modal-template');
                
                document.getElementById('user-modal-title').textContent = 'Edit User';
                document.getElementById('user-edit-id').value = user.id;
                document.getElementById('user-name').value = user.name || '';
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-password').value = '';
                document.getElementById('user-password').required = false;
                document.getElementById('password-hint').textContent = '(leave blank to keep current)';
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-active-field').classList.remove('hidden');
                document.getElementById('user-active').checked = user.is_active;
            } catch (error) {
                Toast.error('Failed to load user: ' + error.message);
            }
        },
        
        async handleSaveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('user-edit-id').value;
            const isEdit = !!userId;
            
            const userData = {
                name: document.getElementById('user-name').value.trim(),
                username: document.getElementById('user-username').value.trim(),
                role: document.getElementById('user-role').value
            };
            
            const password = document.getElementById('user-password').value;
            if (password) {
                userData.password = password;
            } else if (!isEdit) {
                Toast.error('Password is required for new users');
                return;
            }
            
            if (isEdit) {
                userData.is_active = document.getElementById('user-active').checked;
            }
            
            try {
                if (isEdit) {
                    await ApiService.put(`/api/auth/users/${userId}`, userData);
                    Toast.success('User updated successfully');
                } else {
                    await ApiService.post('/api/auth/users', userData);
                    Toast.success('User created successfully');
                }
                
                Modal.close();
                this.currentEditUser = null;
                await this.loadUsers();
            } catch (error) {
                Toast.error('Failed to save user: ' + error.message);
            }
        },
        
        async deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                await ApiService.delete(`/api/auth/users/${userId}`);
                Toast.success('User deleted successfully');
                await this.loadUsers();
            } catch (error) {
                Toast.error('Failed to delete user: ' + error.message);
            }
        }
    };

    // ============================================
    // SETTINGS UI
    // ============================================
    const SettingsUI = {
        async render() {
            await this.loadSettings();
        },
        
        async loadSettings() {
            try {
                const settings = await ApiService.get('/api/settings');
                if (settings) {
                    document.getElementById('settings-company-email').value = settings.company_email || '';
                    document.getElementById('settings-company-name').value = settings.company_name || '';
                    document.getElementById('settings-company-phone').value = settings.company_phone || '';
                    document.getElementById('settings-company-address').value = settings.company_address || '';
                    document.getElementById('settings-notify-tradein').checked = settings.notify_tradein_quote !== false;
                    document.getElementById('settings-notify-repair').checked = settings.notify_repair_status !== false;
                    document.getElementById('settings-notify-ready').checked = settings.notify_ready_pickup !== false;
                }
            } catch (error) {
                console.warn('Failed to load settings:', error);
            }
        },
        
        async saveEmailSettings(event) {
            event.preventDefault();
            
            try {
                await ApiService.put('/api/settings', {
                    company_email: document.getElementById('settings-company-email').value.trim(),
                    company_name: document.getElementById('settings-company-name').value.trim(),
                    company_phone: document.getElementById('settings-company-phone').value.trim(),
                    company_address: document.getElementById('settings-company-address').value.trim()
                });
                Toast.success('Email settings saved');
            } catch (error) {
                Toast.error('Failed to save settings: ' + error.message);
            }
        },
        
        async saveNotificationSettings() {
            try {
                await ApiService.put('/api/settings', {
                    notify_tradein_quote: document.getElementById('settings-notify-tradein').checked,
                    notify_repair_status: document.getElementById('settings-notify-repair').checked,
                    notify_ready_pickup: document.getElementById('settings-notify-ready').checked
                });
                Toast.success('Notification settings saved');
            } catch (error) {
                Toast.error('Failed to save settings: ' + error.message);
            }
        },
        
        async changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('settings-current-password').value;
            const newPassword = document.getElementById('settings-new-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                Toast.error('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 4) {
                Toast.error('Password must be at least 4 characters');
                return;
            }
            
            try {
                await ApiService.post('/api/auth/change-password', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                Toast.success('Password changed successfully');
                document.getElementById('password-change-form').reset();
            } catch (error) {
                Toast.error('Failed to change password: ' + error.message);
            }
        },
        
        previewEmailTemplate(templateType) {
            Modal.show('email-preview-modal-template');
            
            const templates = {
                tradein_quote: {
                    subject: 'Your Trade-In Quote - {company_name}',
                    body: `
                        <h2>Trade-In Quote</h2>
                        <p>Dear {customer_name},</p>
                        <p>Thank you for your trade-in request for your <strong>{device_model}</strong>.</p>
                        <p>Based on the information provided, we're pleased to offer you:</p>
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h3 style="color: #16a34a; margin: 0;">€{offer_amount}</h3>
                        </div>
                        <p>To proceed with this offer, please bring your device to our store or ship it to us.</p>
                        <p>Reference: <strong>{reference_id}</strong></p>
                        <p>Best regards,<br>{company_name}</p>
                    `
                },
                repair_status: {
                    subject: 'Repair Status Update - {ticket_id}',
                    body: `
                        <h2>Repair Status Update</h2>
                        <p>Dear {customer_name},</p>
                        <p>Your repair ticket <strong>{ticket_id}</strong> has been updated.</p>
                        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="margin: 0;"><strong>Device:</strong> {device_model}</p>
                            <p style="margin: 10px 0 0 0;"><strong>New Status:</strong> {status}</p>
                        </div>
                        <p>You can track your repair status online using your ticket ID.</p>
                        <p>Best regards,<br>{company_name}</p>
                    `
                },
                ready_pickup: {
                    subject: 'Your Device is Ready for Pickup! - {ticket_id}',
                    body: `
                        <h2>Ready for Pickup! 🎉</h2>
                        <p>Dear {customer_name},</p>
                        <p>Great news! Your <strong>{device_model}</strong> is ready for pickup.</p>
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <p style="margin: 0;"><strong>Ticket:</strong> {ticket_id}</p>
                            <p style="margin: 10px 0 0 0;"><strong>Store Hours:</strong> Mon-Fri 9AM-6PM, Sat 10AM-2PM</p>
                        </div>
                        <p>Please bring a valid ID when picking up your device.</p>
                        <p>Best regards,<br>{company_name}</p>
                    `
                }
            };
            
            const template = templates[templateType];
            document.getElementById('email-preview-content').innerHTML = template.body
                .replace(/{company_name}/g, 'Your Company')
                .replace(/{customer_name}/g, 'John Doe')
                .replace(/{device_model}/g, 'iPhone 14 Pro')
                .replace(/{offer_amount}/g, '350.00')
                .replace(/{reference_id}/g, 'TRD-0001')
                .replace(/{ticket_id}/g, 'SRV-0001')
                .replace(/{status}/g, 'Ready for Pickup');
        },
        
        sendTestEmail() {
            Toast.info('Test email functionality requires email service configuration');
        }
    };

    // Update App initAfterLogin to show/hide Users nav based on role
    const originalInitAfterLogin = App.initAfterLogin;
    App.initAfterLogin = function() {
        originalInitAfterLogin.call(this);
        
        // Check user role and show/hide Users nav
        const userInfo = JSON.parse(sessionStorage.getItem('user_info') || '{}');
        const usersNav = document.getElementById('nav-users');
        
        if (userInfo.role === 'master_admin') {
            usersNav?.classList.remove('hidden');
        } else {
            usersNav?.classList.add('hidden');
        }
        
        // Update sidebar user info
        if (userInfo.name || userInfo.username) {
            document.getElementById('sidebar-user-name').textContent = userInfo.name || userInfo.username;
            document.getElementById('sidebar-user-role').textContent = userInfo.role === 'master_admin' ? 'Master Admin' : 'Admin';
            document.getElementById('sidebar-user-avatar').textContent = (userInfo.name || userInfo.username).charAt(0).toUpperCase();
        }
        
        // Initialize SyncManager for multi-device sync
        SyncManager.init();
    };

    // Update App.refresh to include users view
    const originalRefresh2 = App.refresh;
    App.refresh = function() {
        originalRefresh2.call(this);
        if (this.currentView === 'users') {
            UsersUI.render();
        }
        if (this.currentView === 'settings') {
            SettingsUI.render();
        }
    };

    // Initialize application when DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
        // Load data from data.json first
        const dataLoaded = await DataLoader.load();
        if (!dataLoaded) {
            console.error('Failed to load data from data.json');
            // Try to continue anyway with empty data
        }
        App.init();
    });
    </script>
</body>
</html>
